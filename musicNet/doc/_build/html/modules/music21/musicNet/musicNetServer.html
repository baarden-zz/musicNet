

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>music21.musicNet.musicNetServer &mdash; musicNet 0.2 documentation</title>
    
    <link rel="stylesheet" href="../../../static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../static/doctools.js"></script>
    <link rel="top" title="musicNet 0.2 documentation" href="../../../index.html" />
    <link rel="up" title="music21.musicNet" href="../musicNet.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">musicNet 0.2 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../musicNet.html" accesskey="U">music21.musicNet</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for music21.musicNet.musicNetServer</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>
<span class="c">#-------------------------------------------------------------------------------</span>
<span class="c"># Name:         musicNetServer.py</span>
<span class="c"># Purpose:      a Python app providing a RESTful interface </span>
<span class="c">#               to the musicNet classes</span>
<span class="c">#</span>
<span class="c"># Authors:      Bret Aarden</span>
<span class="c"># Version:      0.2</span>
<span class="c"># Date:         22Dec2012</span>
<span class="c">#</span>
<span class="c"># License:      MPL 2.0</span>
<span class="c">#-------------------------------------------------------------------------------</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This is an app that provides a RESTful JSON interface to the music21.musicNet objects.</span>
<span class="sd">Any client with the ability to send/receive JSON can use a remote</span>
<span class="sd">server running this app to execute queries and return the results. It&#39;s dependent on</span>
<span class="sd">the Python Bottle module. (Doctests are dependent on the webtest module.)</span>

<span class="sd">Services with a result containing multiple rows return each row as a separate JSONItem:</span>
<span class="sd">rather than returning one JSON document containing an array, each line</span>
<span class="sd">is a separate JSON document containing one row. Any service may return</span>
<span class="sd">a JSONItem dictionary with an &#39;error&#39;/error message key/value pair, so</span>
<span class="sd">clients should check for this possibility.</span>

<span class="sd">Only query-related services are exposed by this interface. Actions that manipulate </span>
<span class="sd">the database can only be done on the server using the musicNet objects directly.</span>

<span class="sd">The app is built with the Bottle framework and will start using its default options</span>
<span class="sd">(localhost:8080).</span>

<span class="sd">Services</span>
<span class="sd">========</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">bottle</span>
<span class="kn">import</span> <span class="nn">music21</span>
<span class="kn">import</span> <span class="nn">music21.musicNet</span>


<span class="c">## {{{ http://code.activestate.com/recipes/577564/ (r2) </span>
<span class="k">class</span> <span class="nc">Silence</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span> <span class="o">=</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combine</span> <span class="o">=</span> <span class="p">(</span><span class="n">stdout</span> <span class="o">==</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
 
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys</span> <span class="o">=</span> <span class="n">sys</span>
        <span class="c"># save previous stdout/stderr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_streams</span> <span class="o">=</span> <span class="n">saved_streams</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fds</span> <span class="o">=</span> <span class="n">fds</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">saved_streams</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_fds</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">,</span> <span class="n">fds</span><span class="p">)</span>
        <span class="c"># flush any pending output</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">saved_streams</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
 
        <span class="c"># open surrogate files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">:</span> 
            <span class="n">null_streams</span> <span class="o">=</span> <span class="p">[</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">:</span>
                <span class="c"># disable buffering so output is merged immediately</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">,</span> <span class="n">fds</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;w&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">null_streams</span> <span class="o">=</span> <span class="p">[</span><span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">null_fds</span> <span class="o">=</span> <span class="n">null_fds</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">null_streams</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">null_streams</span> <span class="o">=</span> <span class="n">null_streams</span>
 
        <span class="c"># overwrite file objects and low-level file descriptors</span>
        <span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">,</span> <span class="n">null_fds</span><span class="p">,</span> <span class="n">fds</span><span class="p">)</span>
 
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">sys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys</span>
        <span class="c"># flush any pending output</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_streams</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="c"># restore original streams and file descriptors</span>
        <span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_fds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fds</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_streams</span>
        <span class="c"># clean up</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_streams</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">False</span>
<span class="c">## end of http://code.activestate.com/recipes/577564/ }}}</span>


<span class="k">class</span> <span class="nc">GeneratePreviews</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inQueue</span><span class="p">,</span> <span class="n">outQueue</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inQueue</span> <span class="o">=</span> <span class="n">inQueue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outQueue</span> <span class="o">=</span> <span class="n">outQueue</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scoreDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inQueue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePreview</span><span class="p">(</span><span class="n">scoreDict</span><span class="p">[</span><span class="s">&#39;score&#39;</span><span class="p">])</span>
            <span class="n">imageDict</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;index&#39;</span><span class="p">:</span> <span class="n">scoreDict</span><span class="p">[</span><span class="s">&#39;index&#39;</span><span class="p">],</span> <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s">&#39;token&#39;</span><span class="p">:</span> <span class="n">scoreDict</span><span class="p">[</span><span class="s">&#39;token&#39;</span><span class="p">]</span> <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inQueue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">imageDict</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">makePreview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score</span><span class="p">):</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;preview&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c"># Create a minimal score with no header or footer</span>
        <span class="n">score</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">music21</span><span class="o">.</span><span class="n">lily</span><span class="o">.</span><span class="n">translate</span><span class="o">.</span><span class="n">LilypondConverter</span><span class="p">()</span>
        <span class="n">conv</span><span class="o">.</span><span class="n">loadFromMusic21Object</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">conv</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">contents</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">music21</span><span class="o">.</span><span class="n">lily</span><span class="o">.</span><span class="n">lilyObjects</span><span class="o">.</span><span class="n">LyLilypondHeader</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">header</span><span class="o">.</span><span class="n">lilypondHeaderBody</span> <span class="o">=</span> <span class="s">&#39;tagline = &quot;&quot;&#39;</span>
        <span class="k">with</span> <span class="n">Silence</span><span class="p">():</span>
            <span class="n">conv</span><span class="o">.</span><span class="n">createPNG</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">)</span>

<span class="c">#-------------------------------------------------------------------------------</span>
<span class="c"># musicNetServer</span>
<span class="c">#-------------------------------------------------------------------------------</span>

<span class="n">bottle</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">bottle</span><span class="o">.</span><span class="n">Bottle</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">catchall</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">app</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">music21</span><span class="o">.</span><span class="n">musicNet</span><span class="o">.</span><span class="n">Database</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">app</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">inQueue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<span class="n">outQueue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<span class="n">previewGen</span> <span class="o">=</span> <span class="n">GeneratePreviews</span><span class="p">(</span><span class="n">inQueue</span><span class="p">,</span> <span class="n">outQueue</span><span class="p">)</span>
<span class="n">previewGen</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">previewGen</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">listScores</span>
<span class="sd">----------</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="nd">@app.get</span><span class="p">(</span><span class="s">&#39;/listscores&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="listScores"><a class="viewcode-back" href="../../../musicNetServer.html#music21.musicNet.musicNetServer.listScores">[docs]</a><span class="k">def</span> <span class="nf">listScores</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Server address::</span>
<span class="sd"> </span>
<span class="sd">        /listscores?start=0&amp;limit=100</span>
<span class="sd">    </span>
<span class="sd">    Request parameters::</span>
<span class="sd">    </span>
<span class="sd">        start - The first row of scores to return (default=0).</span>
<span class="sd">        limit - The number of scores to return (default=100).</span>
<span class="sd">    </span>
<span class="sd">    Response: a JSONItem dictionary for each score in the database.</span>
<span class="sd">    </span>
<span class="sd">    Data structure::</span>

<span class="sd">        { movementName: name_of_score_file, _names: [ contributor, ... ], index: original_path_of_score_file }</span>
<span class="sd">        { movementName: name_of_score_file, _names: [ contributor, ... ], index: original_path_of_score_file }</span>
<span class="sd">        ...</span>
<span class="sd">    </span>
<span class="sd">    We can test the functioning of the app without actually starting it by using the :class:`webtest`</span>
<span class="sd">    framework:</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; from webtest import TestApp</span>
<span class="sd">    &gt;&gt;&gt; import music21.musicNet.musicNetServer as mns</span>
<span class="sd">    &gt;&gt;&gt; webapp = TestApp(mns.app)</span>
<span class="sd">    &gt;&gt;&gt; r = webapp.get(&#39;/listscores&#39;)</span>
<span class="sd">    &gt;&gt;&gt; import json</span>
<span class="sd">    &gt;&gt;&gt; sorted(json.loads(r.body).items())</span>
<span class="sd">    [(u&#39;_names&#39;, [None]), (u&#39;corpusFilepath&#39;, u&#39;bach/bwv84.5.mxl&#39;), (u&#39;movementName&#39;, u&#39;bwv84.5.mxl&#39;)]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">bottle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">limit</span> <span class="ow">or</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">listScores</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
</div>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">listNodeTypes</span>
<span class="sd">-------------</span>
<span class="sd">&#39;&#39;&#39;</span>     
<span class="nd">@app.get</span><span class="p">(</span><span class="s">&#39;/listnodetypes&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="listNodeTypes"><a class="viewcode-back" href="../../../musicNetServer.html#music21.musicNet.musicNetServer.listNodeTypes">[docs]</a><span class="k">def</span> <span class="nf">listNodeTypes</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;    </span>
<span class="sd">    Server address::</span>
<span class="sd"> </span>
<span class="sd">        /listnodetypes</span>
<span class="sd">    </span>
<span class="sd">    Request parameters: none.</span>
<span class="sd">    </span>
<span class="sd">    Response: a JSON array of node types in the database.</span>
<span class="sd">    </span>
<span class="sd">    Data structure::</span>

<span class="sd">        [ &#39;score&#39;, &#39;metadata&#39;, &#39;note&#39;, ... ]</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; from webtest import TestApp</span>
<span class="sd">    &gt;&gt;&gt; import music21.musicNet.musicNetServer as mns</span>
<span class="sd">    &gt;&gt;&gt; webapp = TestApp(mns.app)</span>
<span class="sd">    &gt;&gt;&gt; r = webapp.get(&#39;/listnodetypes&#39;)</span>
<span class="sd">    &gt;&gt;&gt; import json</span>
<span class="sd">    &gt;&gt;&gt; json.loads(r.body)</span>
<span class="sd">    [u&#39;StaffGroup&#39;, u&#39;SystemLayout&#39;, u&#39;Beam&#39;, u&#39;Score&#39;, u&#39;Rest&#39;, u&#39;Note&#39;, u&#39;Instrument&#39;, u&#39;Moment&#39;, u&#39;Part&#39;, u&#39;Measure&#39;, u&#39;Barline&#39;, u&#39;Expression&#39;, u&#39;Metadata&#39;]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">listNodeTypes</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
</div>
<span class="nd">@app.get</span><span class="p">(</span><span class="s">&#39;/listnodeproperties&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="listNodeProperties"><a class="viewcode-back" href="../../../musicNetServer.html#music21.musicNet.musicNetServer.listNodeProperties">[docs]</a><span class="k">def</span> <span class="nf">listNodeProperties</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Server address::</span>
<span class="sd"> </span>
<span class="sd">        /listnodeproperties</span>
<span class="sd">    </span>
<span class="sd">    Request parameters: none.</span>
<span class="sd">    </span>
<span class="sd">    Response: </span>
<span class="sd">    </span>
<span class="sd">        A JSON array for each node property type in the database. The first element is the node</span>
<span class="sd">        type, and the second element is the name of the property.</span>
<span class="sd">        </span>
<span class="sd">    Data structure::</span>
<span class="sd">    </span>
<span class="sd">        [&#39;StaffGroup&#39;, &#39;offset&#39;]</span>
<span class="sd">        [&#39;SystemLayout&#39;, &#39;distance&#39;]</span>
<span class="sd">        [&#39;SystemLayout&#39;, &#39;quarterLength&#39;]</span>
<span class="sd">        ...</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; from webtest import TestApp</span>
<span class="sd">    &gt;&gt;&gt; import music21.musicNet.musicNetServer as mns</span>
<span class="sd">    &gt;&gt;&gt; webapp = TestApp(mns.app)</span>
<span class="sd">    &gt;&gt;&gt; r = webapp.get(&#39;/listnodeproperties&#39;)</span>
<span class="sd">    &gt;&gt;&gt; import json</span>
<span class="sd">    &gt;&gt;&gt; json.loads(r.body.splitlines()[0])</span>
<span class="sd">    [u&#39;StaffGroup&#39;, u&#39;offset&#39;]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">listNodeProperties</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
</div>
<span class="nd">@app.get</span><span class="p">(</span><span class="s">&#39;/listrelationshiptypes&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="listRelationshipTypes"><a class="viewcode-back" href="../../../musicNetServer.html#music21.musicNet.musicNetServer.listRelationshipTypes">[docs]</a><span class="k">def</span> <span class="nf">listRelationshipTypes</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Server address::</span>
<span class="sd"> </span>
<span class="sd">        /listrelationshiptypes</span>
<span class="sd">    </span>
<span class="sd">    Request parameters: none.</span>
<span class="sd">    </span>
<span class="sd">    Response: </span>
<span class="sd">    </span>
<span class="sd">        A JSONItem dictionary for each kind of relationship in the database, including</span>
<span class="sd">        the type of node at the start and end of the relationship.</span>
<span class="sd">    </span>
<span class="sd">    Data structure::</span>
<span class="sd">    </span>
<span class="sd">        {&#39;start&#39;: u&#39;Note&#39;, &#39;end&#39;: u&#39;Measure&#39;, &#39;type&#39;: u&#39;NoteInMeasure&#39;}</span>
<span class="sd">        {&#39;start&#39;: u&#39;Part&#39;, &#39;end&#39;: u&#39;Score&#39;, &#39;type&#39;: u&#39;PartInScore&#39;}</span>
<span class="sd">        ...</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; from webtest import TestApp</span>
<span class="sd">    &gt;&gt;&gt; import music21.musicNet.musicNetServer as mns</span>
<span class="sd">    &gt;&gt;&gt; webapp = TestApp(mns.app)</span>
<span class="sd">    &gt;&gt;&gt; r = webapp.get(&#39;/listrelationshiptypes&#39;)</span>
<span class="sd">    &gt;&gt;&gt; import json</span>
<span class="sd">    &gt;&gt;&gt; json.loads(r.body.splitlines()[0])</span>
<span class="sd">    {u&#39;start&#39;: u&#39;Note&#39;, u&#39;end&#39;: u&#39;Measure&#39;, u&#39;type&#39;: u&#39;NoteInMeasure&#39;}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">listRelationshipTypes</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
</div>
<span class="nd">@app.get</span><span class="p">(</span><span class="s">&#39;/listrelationshipproperties&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="listRelationshipProperties"><a class="viewcode-back" href="../../../musicNetServer.html#music21.musicNet.musicNetServer.listRelationshipProperties">[docs]</a><span class="k">def</span> <span class="nf">listRelationshipProperties</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Server address::</span>
<span class="sd"> </span>
<span class="sd">        /listrelationshipproperties</span>
<span class="sd">    </span>
<span class="sd">    Request parameters: none.</span>
<span class="sd">    </span>
<span class="sd">    Response: </span>
<span class="sd">    </span>
<span class="sd">        A 2-element JSONItem array for each kind of Relationship property in the database:</span>
<span class="sd">        the first item is the Relationship type, and the second is the name of the property.</span>
<span class="sd">    </span>
<span class="sd">    Data structure::</span>
<span class="sd">    </span>
<span class="sd">        [&#39;NoteToNoteByBeat&#39;, &#39;interval&#39;]</span>
<span class="sd">        [&#39;NoteToNote&#39;, &#39;interval&#39;]</span>
<span class="sd">        ...</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; from webtest import TestApp</span>
<span class="sd">    &gt;&gt;&gt; import music21.musicNet.musicNetServer as mns</span>
<span class="sd">    &gt;&gt;&gt; webapp = TestApp(mns.app)</span>
<span class="sd">    &gt;&gt;&gt; r = webapp.get(&#39;/listrelationshiptypes&#39;)</span>
<span class="sd">    &gt;&gt;&gt; import json</span>
<span class="sd">    &gt;&gt;&gt; sorted(json.loads(r.body.splitlines()[0]).items())</span>
<span class="sd">    [(u&#39;end&#39;, u&#39;Measure&#39;), (u&#39;start&#39;, u&#39;Note&#39;), (u&#39;type&#39;, u&#39;NoteInMeasure&#39;)]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">listRelationshipProperties</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
</div>
<span class="nd">@app.get</span><span class="p">(</span><span class="s">&#39;/images/&lt;filename:re:.*\.png&gt;#&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sendImage</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">bottle</span><span class="o">.</span><span class="n">static_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;image/png&#39;</span><span class="p">)</span>

<span class="nd">@app.post</span><span class="p">(</span><span class="s">&#39;/submitquery&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="prepareQuery"><a class="viewcode-back" href="../../../musicNetServer.html#music21.musicNet.musicNetServer.prepareQuery">[docs]</a><span class="k">def</span> <span class="nf">prepareQuery</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Server address::</span>
<span class="sd"> </span>
<span class="sd">        /submitquery</span>
<span class="sd">    </span>
<span class="sd">    This service processes a JSON query and returns an integer token that can be used</span>
<span class="sd">    to obtain results using &#39;getresults&#39; and &#39;getimages&#39;. Unlike</span>
<span class="sd">    the other services, it uses the POST method and expects the body of the request</span>
<span class="sd">    to be a JSON document containing the query. Tokens are good for a</span>
<span class="sd">    half hour before they expire.</span>
<span class="sd">    </span>
<span class="sd">    The JSON query is expected to be an object with specific key/value pairs:</span>
<span class="sd">    </span>
<span class="sd">      nodes</span>
<span class="sd">        An array of objects, one per node, each identifying its </span>
<span class="sd">        &#39;type&#39; and its &#39;name&#39; in the query.</span>
<span class="sd">      relationships</span>
<span class="sd">        An array of objects, one per relationship, each identifying its &#39;type&#39;, </span>
<span class="sd">        the name of its &#39;start&#39; node, the name of its &#39;end&#39; node, and its own &#39;name&#39; </span>
<span class="sd">        in the query.</span>
<span class="sd">      startNode</span>
<span class="sd">        The name of the starting node for the query.</span>
<span class="sd">      startRelationship</span>
<span class="sd">        The name of the starting relationship for the query. There must be </span>
<span class="sd">        exactly one startNode or startRelationship per query. Results are</span>
<span class="sd">        ordered by the ID of the start object.</span>
<span class="sd">      relationshipProperties</span>
<span class="sd">        An array of objects, one per relationship property that is referenced</span>
<span class="sd">        in the query, each identifying the name of the &#39;relationship&#39;, the</span>
<span class="sd">        relationship &#39;property&#39;, and its &#39;name&#39; in the query.</span>
<span class="sd">      nodeProperties</span>
<span class="sd">        An array of objects, one per node property that is referenced</span>
<span class="sd">        in the query, each identifying the name of the &#39;node&#39;, the</span>
<span class="sd">        node &#39;property&#39;, and its &#39;name&#39; in the query.</span>
<span class="sd">      comparisonFilters</span>
<span class="sd">        An array of objects, one per comparison filter. Each object should specify</span>
<span class="sd">        the comparison &#39;operator&#39; (one of `=&#39;, &#39;&lt;&gt;&#39;, &#39;&lt;&#39;, &#39;&gt;&#39;, &#39;&lt;=&#39;,` or &#39;&gt;=&#39;),</span>
<span class="sd">        the comparison prefix (&#39;pre&#39; and &#39;preType&#39;) and comparison postfix</span>
<span class="sd">        (&#39;post&#39; and &#39;postType&#39;). The pre/post type can be either a &#39;property&#39; (a property</span>
<span class="sd">        name) or a &#39;value&#39; (a number, string, or boolean). </span>
<span class="sd">      returns</span>
<span class="sd">        An array of property names that will be returned by the query. </span>
<span class="sd">      makePreviews</span>
<span class="sd">        A boolean indicating whether previews will be created. Queries that</span>
<span class="sd">        specify returns are not compatible with the &#39;makePreviews&#39; option.</span>
<span class="sd">        Preview URLs can be obtained from the getimage service.</span>
<span class="sd">    </span>
<span class="sd">    For instance::</span>
<span class="sd">    </span>
<span class="sd">        { &#39;nodes&#39;: [ { &#39;type&#39;: &#39;Note&#39;, &#39;name&#39;: &#39;n1&#39; },</span>
<span class="sd">                     { &#39;type&#39;: &#39;Note&#39;, &#39;name&#39;: &#39;n2&#39; } ],</span>
<span class="sd">          &#39;relationships&#39;: [ { &#39;start&#39;: &#39;n1&#39;, &#39;type&#39;: &#39;NoteSimultaneousWithNote&#39;, &#39;end&#39;: &#39;n2&#39;, &#39;name&#39;: &#39;nswn&#39; } ],</span>
<span class="sd">          &#39;startNode&#39;: &#39;n1&#39;,</span>
<span class="sd">          &#39;relationshipProperties&#39;: [ { &#39;relationship&#39;: &#39;nswn&#39;, &#39;property&#39;: &#39;sameOffset&#39;, &#39;name&#39;: &#39;nswnSo&#39; },</span>
<span class="sd">                                      { &#39;relationship&#39;: &#39;nswn&#39;, &#39;property&#39;: &#39;simpleHarmonicInterval&#39;, &#39;name&#39;: &#39;nswnShi&#39; } ],</span>
<span class="sd">          &#39;comparisonFilters&#39;: [ { &#39;preType&#39;: &#39;property&#39;, &#39;pre&#39;: &#39;nswnSo&#39;, &#39;operator&#39;: &#39;=&#39;, &#39;postType&#39;: &#39;value&#39;, &#39;post&#39;: &#39;True&#39; },</span>
<span class="sd">                                 { &#39;preType&#39;: &#39;property&#39;, &#39;pre&#39;: &#39;nswnShi&#39;, &#39;operator&#39;: &#39;=&#39;, &#39;postType&#39;: &#39;value&#39;, &#39;post&#39;: 7 } ],</span>
<span class="sd">          &#39;returns&#39;: [],</span>
<span class="sd">          &#39;makePreviews&#39;: &#39;True&#39;</span>
<span class="sd">        }</span>
<span class="sd">    </span>
<span class="sd">    Data structure::</span>
<span class="sd">    </span>
<span class="sd">        {&#39;token&#39;: -4258737148674360350}</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; import webtest</span>
<span class="sd">    &gt;&gt;&gt; import music21.musicNet.musicNetServer as mns</span>
<span class="sd">    &gt;&gt;&gt; webapp = webtest.TestApp(mns.app)</span>
<span class="sd">    &gt;&gt;&gt; req = { &#39;nodes&#39;: [ { &#39;type&#39;: &#39;Note&#39;, &#39;name&#39;: &#39;n1&#39; } ], &#39;startNode&#39;: &#39;n1&#39; }</span>
<span class="sd">    &gt;&gt;&gt; import json</span>
<span class="sd">    &gt;&gt;&gt; r = webapp.post_json(&#39;/submitquery&#39;, req)</span>
<span class="sd">    &gt;&gt;&gt; json.loads(r.body)</span>
<span class="sd">    {u&#39;token&#39;: ...}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">bottle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">music21</span><span class="o">.</span><span class="n">musicNet</span><span class="o">.</span><span class="n">Query</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">relations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;nodes&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span> <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;query has no nodes&#39;</span> <span class="p">}</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">req</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">]:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">nodes</span><span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">node</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;relationships&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]]</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;end&#39;</span><span class="p">]]</span>
        <span class="n">optional</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&#39;optional&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">relation</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">],</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> 
                                     <span class="n">name</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">optional</span><span class="o">=</span><span class="n">optional</span><span class="p">)</span>
        <span class="n">relations</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relation</span>
    <span class="k">if</span> <span class="s">&#39;startNode&#39;</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
        <span class="n">q</span><span class="o">.</span><span class="n">setStartNode</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">req</span><span class="p">[</span><span class="s">&#39;startNode&#39;</span><span class="p">]])</span>
    <span class="k">elif</span> <span class="s">&#39;startRelationship&#39;</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
        <span class="n">q</span><span class="o">.</span><span class="n">setStartRelationship</span><span class="p">(</span><span class="n">relations</span><span class="p">[</span><span class="n">req</span><span class="p">[</span><span class="s">&#39;startRelationship&#39;</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span> <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;query has no start&#39;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;nodeProperties&#39;</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">req</span><span class="p">[</span><span class="s">&#39;nodeProperties&#39;</span><span class="p">]:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;node&#39;</span><span class="p">]]</span>
            <span class="n">properties</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s">&#39;property&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s">&#39;relationshipProperties&#39;</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">req</span><span class="p">[</span><span class="s">&#39;relationshipProperties&#39;</span><span class="p">]:</span>
            <span class="n">relation</span> <span class="o">=</span> <span class="n">relations</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;relationship&#39;</span><span class="p">]]</span>
            <span class="n">properties</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s">&#39;property&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s">&#39;comparisonFilters&#39;</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">req</span><span class="p">[</span><span class="s">&#39;comparisonFilters&#39;</span><span class="p">]:</span>
            <span class="n">addComparisonFilter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;returns&#39;</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">req</span><span class="p">[</span><span class="s">&#39;returns&#39;</span><span class="p">]:</span>
            <span class="n">q</span><span class="o">.</span><span class="n">addReturns</span><span class="p">(</span><span class="n">properties</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;property&#39;</span><span class="p">]])</span>
    <span class="n">previews</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;makePreviews&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">previews</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">returns</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span> <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;&quot;makePreviews&quot; and &quot;results&quot; cannot be combined in the same query&#39;</span> <span class="p">}</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">_assemblePattern</span><span class="p">()</span>
    <span class="n">ipAddr</span> <span class="o">=</span> <span class="n">bottle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span> <span class="ow">or</span> <span class="s">&quot;None&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">ipAddr</span> <span class="o">+</span> <span class="n">pattern</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="p">,</span> <span class="n">previews</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()]</span>
    <span class="n">expireTokens</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span> <span class="s">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span> <span class="p">}</span>
    </div>
<span class="nd">@app.get</span><span class="p">(</span><span class="s">&#39;/getresults&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="results"><a class="viewcode-back" href="../../../musicNetServer.html#music21.musicNet.musicNetServer.results">[docs]</a><span class="k">def</span> <span class="nf">results</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Server address::</span>
<span class="sd">     </span>
<span class="sd">        /getresults?token=nnn&amp;row=0&amp;limit=10</span>
<span class="sd">    </span>
<span class="sd">    Request parameters::</span>

<span class="sd">        token - The number returned by the submitquery service</span>
<span class="sd">        row   - The first row of the query to return (default=0)</span>
<span class="sd">        limit - The number of query results to return (default=10)</span>
<span class="sd">    </span>
<span class="sd">    Response: </span>
<span class="sd">    </span>
<span class="sd">        A series of JSONItem dictionaries: first the metadata for the</span>
<span class="sd">        results (the list of column names), then the data rows.</span>
<span class="sd">        A &#39;type&#39; key indicates the kind of row, and the information</span>
<span class="sd">        is indexed by the &#39;data&#39; key. Data rows also have a &#39;index&#39;</span>
<span class="sd">        key indicating the line number of the result.</span>
<span class="sd">        </span>
<span class="sd">        A typical strategy is to send requests to this service,</span>
<span class="sd">        incrementing the row by the limit each time, until it</span>
<span class="sd">        returns an empty response.</span>
<span class="sd">    </span>
<span class="sd">    Data structure::</span>
<span class="sd">    </span>
<span class="sd">        {&#39;type&#39;: &#39;metadata&#39;, &#39;data&#39;: [&#39;nswn&#39;, &#39;p2&#39;, &#39;n1&#39;, &#39;p1&#39;, &#39;ntn1&#39;, &#39;n2&#39;, &#39;ntn2&#39;, &#39;p1&#39;, &#39;m1&#39;]}</span>
<span class="sd">        {&#39;type&#39;: &#39;data&#39;, &#39;index&#39;: 0, &#39;data&#39;: [7, &#39;D4&#39;, &#39;F#4&#39;, &#39;B4&#39;, -5, &#39;B3&#39;, -3, &#39;Soprano&#39;, &#39;Tenor&#39;, 5]}</span>
<span class="sd">        {&#39;type&#39;: &#39;data&#39;, &#39;index&#39;: 1, &#39;data&#39;: [19, &#39;B3&#39;, &#39;C#5&#39;, &#39;D5&#39;, -1, &#39;F#3&#39;, -5, &#39;Soprano&#39;, &#39;Bass&#39;, 6]}</span>
<span class="sd">        ...</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>
<span class="sd">        </span>
<span class="sd">    &gt;&gt;&gt; import webtest</span>
<span class="sd">    &gt;&gt;&gt; import music21.musicNet.musicNetServer as mns</span>
<span class="sd">    &gt;&gt;&gt; webapp = webtest.TestApp(mns.app)</span>
<span class="sd">    &gt;&gt;&gt; req = { &#39;nodes&#39;: [ { &#39;type&#39;: &#39;Note&#39;, &#39;name&#39;: &#39;n1&#39; } ], &#39;startNode&#39;: &#39;n1&#39; }</span>
<span class="sd">    &gt;&gt;&gt; r = webapp.post_json(&#39;/submitquery&#39;, req)</span>
<span class="sd">    &gt;&gt;&gt; import json</span>
<span class="sd">    &gt;&gt;&gt; token = json.loads(r.body)[&#39;token&#39;]</span>
<span class="sd">    &gt;&gt;&gt; r = webapp.get(&#39;/getresults?token=%s&amp;start=0&amp;limit=1&#39; % token)</span>
<span class="sd">    &gt;&gt;&gt; sorted(json.loads(r.body.splitlines()[0]).items())</span>
<span class="sd">    [(u&#39;data&#39;, [u&#39;n1&#39;]), (u&#39;type&#39;, u&#39;metadata&#39;)]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">bottle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span>
    <span class="n">token</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
    <span class="n">minRow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">row</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">limit</span> <span class="ow">or</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;That token is invalid or has expired.&#39;</span> <span class="p">}</span>
        <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>
    <span class="n">pattern</span><span class="p">,</span> <span class="n">previews</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">music21</span><span class="o">.</span><span class="n">musicNet</span><span class="o">.</span><span class="n">Query</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">minRow</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">queryIdx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">minRow</span>
        <span class="k">if</span> <span class="n">previews</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">music21Score</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="n">inQueue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span> <span class="s">&#39;index&#39;</span><span class="p">:</span> <span class="n">queryIdx</span><span class="p">,</span> <span class="s">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span> <span class="p">})</span>
            <span class="n">addScoreInfo</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c"># wait until after previews have added data to return metadata</span>
            <span class="n">item</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;metadata&#39;</span><span class="p">,</span> <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="n">metadata</span> <span class="p">}</span>
            <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="s">&#39;index&#39;</span><span class="p">:</span> <span class="n">queryIdx</span><span class="p">,</span> <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="n">row</span> <span class="p">}</span>
        <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">expireTokens</span><span class="p">()</span>
</div>
<span class="nd">@app.get</span><span class="p">(</span><span class="s">&#39;/getimages&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="getImage"><a class="viewcode-back" href="../../../musicNetServer.html#music21.musicNet.musicNetServer.getImage">[docs]</a><span class="k">def</span> <span class="nf">getImage</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Server address::</span>
<span class="sd"> </span>
<span class="sd">        /getimages?token=nnn&amp;block=false</span>

<span class="sd">    Request parameters::</span>

<span class="sd">        token - The number returned by the submitquery service</span>
<span class="sd">        block - [optional] if true, the query will block for a response</span>
<span class="sd">    </span>
<span class="sd">    Response: </span>
<span class="sd">    </span>
<span class="sd">        Zero or more JSONItem objects. The &#39;path&#39; key/value pair</span>
<span class="sd">        contains the path that an HTTP request can use to obtain the</span>
<span class="sd">        preview PNG. An &#39;index&#39; key/value indicates the corresponding query</span>
<span class="sd">        result row for this image. A &#39;type&#39; key indicating that this is a</span>
<span class="sd">        &#39;preview&#39; is included in case it&#39;s useful.</span>
<span class="sd">        </span>
<span class="sd">        An empty response is _not_ an indication that all previews have been</span>
<span class="sd">        generated. It is up to the client to keep track of how many</span>
<span class="sd">        previews are expected. Sending requests to this service more than</span>
<span class="sd">        2-4 times a second is probably not useful.</span>
<span class="sd">        Previews are generated after a call to the result service.</span>
<span class="sd">    </span>
<span class="sd">    Data structure::</span>
<span class="sd">    </span>
<span class="sd">        {&#39;url&#39;: &#39;/images/previewJHUqde.png&#39;, &#39;index&#39;: 0, &#39;type&#39;: &#39;preview&#39;}</span>
<span class="sd">        {&#39;url&#39;: &#39;/images/previewriWX1Z.png&#39;, &#39;index&#39;: 1, &#39;type&#39;: &#39;preview&#39;}</span>
<span class="sd">        {&#39;url&#39;: &#39;/images/previewf0PvMb.png&#39;, &#39;index&#39;: 2, &#39;type&#39;: &#39;preview&#39;}</span>
<span class="sd">        ...</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; import webtest</span>
<span class="sd">    &gt;&gt;&gt; import music21.musicNet.musicNetServer as mns</span>
<span class="sd">    &gt;&gt;&gt; webapp = webtest.TestApp(mns.app)</span>
<span class="sd">    &gt;&gt;&gt; req = { &#39;nodes&#39;: [ { &#39;type&#39;: &#39;Note&#39;, &#39;name&#39;: &#39;n2&#39; } ], &#39;startNode&#39;: &#39;n2&#39;, &#39;makePreviews&#39;: True }</span>
<span class="sd">    &gt;&gt;&gt; r = webapp.post_json(&#39;/submitquery&#39;, req)</span>
<span class="sd">    &gt;&gt;&gt; import json</span>
<span class="sd">    &gt;&gt;&gt; token = json.loads(r.body)[&#39;token&#39;]</span>
<span class="sd">    &gt;&gt;&gt; r = webapp.get(&#39;/getresults?token=%s&amp;start=0&amp;limit=1&#39; % token)</span>
<span class="sd">    &gt;&gt;&gt; r = webapp.get(&#39;/getimages?token=%s&amp;block=true&#39; % token)                # doctest: +SKIP</span>
<span class="sd">    &gt;&gt;&gt; sorted(json.loads(r.body).items())                                      # doctest: +SKIP</span>
<span class="sd">    [(u&#39;index&#39;, 0), (u&#39;type&#39;, u&#39;preview&#39;), (u&#39;url&#39;, u&#39;/images/preview...png&#39;)]  # doctest: +SKIP</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bottle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;That token is invalid or has expired.&#39;</span> <span class="p">}</span>
        <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>
    <span class="n">makePreviews</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">makePreviews</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;makePreviews was not set in the query submission.&#39;</span> <span class="p">}</span>
        <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>
    <span class="k">if</span> <span class="n">bottle</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>
        <span class="n">imageDict</span> <span class="o">=</span> <span class="n">outQueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">outQueue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
        <span class="n">addImage</span><span class="p">(</span><span class="n">imageDict</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imageDict</span> <span class="o">=</span> <span class="n">outQueue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">outQueue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
        <span class="n">addImage</span><span class="p">(</span><span class="n">imageDict</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">while</span> <span class="n">images</span><span class="p">:</span>
        <span class="n">imageDict</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;preview&#39;</span><span class="p">,</span> <span class="s">&#39;index&#39;</span><span class="p">:</span> <span class="n">imageDict</span><span class="p">[</span><span class="s">&#39;index&#39;</span><span class="p">],</span> <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="s">&#39;/images/&#39;</span> <span class="o">+</span> <span class="n">imageDict</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">]</span> <span class="p">}</span>
        <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">expireTokens</span><span class="p">()</span>
    </div>
<span class="k">def</span> <span class="nf">addImage</span><span class="p">(</span><span class="n">imageDict</span><span class="p">):</span>
    <span class="n">imgToken</span> <span class="o">=</span> <span class="n">imageDict</span><span class="p">[</span><span class="s">&#39;token&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">imgToken</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imageDict</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">imgToken</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">imageDict</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">addComparisonFilter</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">comparison</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
    <span class="n">pre</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s">&#39;pre&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">comparison</span><span class="p">[</span><span class="s">&#39;preType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;property&#39;</span><span class="p">:</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s">&#39;post&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">comparison</span><span class="p">[</span><span class="s">&#39;postType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;property&#39;</span><span class="p">:</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="n">post</span><span class="p">]</span>
    <span class="n">query</span><span class="o">.</span><span class="n">addComparisonFilter</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">comparison</span><span class="p">[</span><span class="s">&#39;operator&#39;</span><span class="p">],</span> <span class="n">post</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">addScoreInfo</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">getElementsByClass</span><span class="p">(</span><span class="n">music21</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">Part</span><span class="p">)</span>
    <span class="n">measures</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getElementsByClass</span><span class="p">(</span><span class="n">music21</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">Measure</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)):</span>
        <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">objectValueMap</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;p</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getElementsByClass</span><span class="p">(</span><span class="n">music21</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">Instrument</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instrument</span><span class="o">.</span><span class="n">partName</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">measures</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;m</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">measures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">objectValueMap</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">music21</span><span class="o">.</span><span class="n">musicNet</span><span class="o">.</span><span class="n">_getPy2neoMetadata</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="s">&#39;data&#39;</span><span class="p">]</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;Note&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;pitch&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;NoteSimultaneousWithNote&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;harmonicInterval&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;NoteToNote&#39;</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;NoteToNoteByBeat&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;interval&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;-&#39;</span>

<span class="k">def</span> <span class="nf">expireTokens</span><span class="p">():</span>
    <span class="c"># Remove tokens that are older than 30 minutes.</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1800</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">app</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">bottle</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">reloader</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    

<span class="c">#    _prepDoctests()</span>
<span class="c">#    music21.mainTest(Test)</span>

<span class="c"># This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. </span>
<span class="c"># If a copy of the MPL was not distributed with this file, You can obtain one at </span>
<span class="c"># http://mozilla.org/MPL/2.0/.</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">musicNet 0.2 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../musicNet.html" >music21.musicNet</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Bret Aarden.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>