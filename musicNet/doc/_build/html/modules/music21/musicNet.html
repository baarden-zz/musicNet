

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>music21.musicNet &mdash; musicNet 0.2 documentation</title>
    
    <link rel="stylesheet" href="../../static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../static/jquery.js"></script>
    <script type="text/javascript" src="../../static/underscore.js"></script>
    <script type="text/javascript" src="../../static/doctools.js"></script>
    <link rel="top" title="musicNet 0.2 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">musicNet 0.2 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for music21.musicNet</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>
<span class="c">#-------------------------------------------------------------------------------</span>
<span class="c"># Name:         musicNet.py</span>
<span class="c"># Purpose:      classes for connecting music21 to and searching Neo4j</span>
<span class="c">#</span>
<span class="c"># Authors:      Bret Aarden</span>
<span class="c"># Version:      0.2</span>
<span class="c"># Date:         29Jul2012</span>
<span class="c">#</span>
<span class="c"># License:      MPL 2.0</span>
<span class="c">#-------------------------------------------------------------------------------</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">.. testsetup:: *</span>

<span class="sd">    import music21.musicNet</span>
<span class="sd">    music21.musicNet._prepDoctests()</span>

<span class="sd">The musicNet module provides objects for searching music data in a network database</span>
<span class="sd">(specifically the Neo4j database), and for adding music21 data to the database. </span>
<span class="sd">Queries are constructed by creating relationships between objects (notes, measures, parts, etc.).</span>
<span class="sd">This hides much of the mechanics of searching through music data, but</span>
<span class="sd">the database format is relatively fixed, unlike music21.</span>

<span class="sd">The :class:`Database` object provides an interface with the database to add a music21 </span>
<span class="sd">:class:`~music21.stream.Score` and get information about the database contents, </span>
<span class="sd">such as the available scores, relationships, and properties.</span>

<span class="sd">The :class:`Query` object provides an interface for building and executing queries of the database.</span>
<span class="sd">It also has a :meth:`Query.music21Score` method for generating a music21</span>
<span class="sd">Score from a result.</span>

<span class="sd">There are also database :class:`Entity` objects that help with building the queries, including</span>
<span class="sd">:class:`Node`, :class:`Relationship`, :class:`Property`, and :class:`Filter` objects.</span>

<span class="sd">:class:`Moment` objects can be added to music21 objects using the module-level </span>
<span class="sd">:meth:`addMomentsToScore` method. These objects have a similar function to</span>
<span class="sd">:class:`~music21.voiceLeading.VerticalSlice` objects. When present in a score, they</span>
<span class="sd">add cross-:class:`~music21.stream.Part` relationships to Notes in the database.</span>

<span class="sd">Configuration</span>
<span class="sd">-------------</span>

<span class="sd">This module requires that the `py2neo &lt;http://py2neo.org/&gt;`_ Python module be installed,</span>
<span class="sd">and that you have access to a `Neo4j &lt;http://neo4j.org/&gt;`_ database (version 1.8 or newer).</span>

<span class="sd">The database must be configured to use automatic indexing. (Well, technically it doesn&#39;t, </span>
<span class="sd">but it will make open-ended searches a lot faster.) This involves editing the</span>
<span class="sd">`conf/neo4j.properties` file in the database folder. The following lines should be </span>
<span class="sd">uncommented (the leading hash mark should be deleted) and edited as shown::</span>

<span class="sd">    node_auto_indexing=true</span>
<span class="sd">    node_keys_indexable=type</span>
<span class="sd">    relationship_auto_indexing=true</span>
<span class="sd">    relationship_keys_indexable=type</span>

<span class="sd">Neo4j operation is nearly plug-and-play. To start the database server from the command line,</span>
<span class="sd">just move to the database directory and enter::</span>

<span class="sd">    $ bin/neo4j start</span>
<span class="sd">    </span>
<span class="sd">Contents</span>
<span class="sd">------------- </span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c">#TO DO:</span>
<span class="c">#LONG TERM:</span>
<span class="c">#Implement a programmatic replacement for Query.addCypherFilter(),</span>
<span class="c">#  maybe by overriding Python operators, a la SQLAlchemy?</span>
<span class="c">#Add inspect disk caching.</span>
<span class="c">#Optimize speed and memory profiles. Goldberg Variations, argggh!</span>

<span class="c">#Suggestions for music21:</span>
<span class="c">#Change Measure.keySignature, .timeSignature, and .clef from None to weakRefs.</span>
<span class="c">#Add direct means of manipulating Lilypond headers (removing tagline, etc.)</span>

<span class="c">#Suggestions for py2neo</span>
<span class="c">#Authorization on databases doesn&#39;t appear to work with .create().</span>
<span class="c">#Tornado __del__ errors on exit should be fixed!</span>


<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">unittest</span><span class="o">,</span> <span class="nn">doctest</span>
<span class="kn">import</span> <span class="nn">py2neo.neo4j</span>
<span class="kn">import</span> <span class="nn">music21</span>
<span class="kn">from</span> <span class="nn">music21</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">def</span> <span class="nf">_prepDoctests</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;This function is run before starting doctests. </span>
<span class="sd">    Results from the tests depend on the state of the database, and this function will</span>
<span class="sd">    purge the database and import a sample file.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">wipeDatabase</span><span class="p">()</span>
    <span class="n">bwv84_5</span> <span class="o">=</span> <span class="n">music21</span><span class="o">.</span><span class="n">corpus</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&#39;bach/bwv84.5.mxl&#39;</span><span class="p">)</span>
    <span class="n">addMomentsToScore</span><span class="p">(</span><span class="n">bwv84_5</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">addScore</span><span class="p">(</span><span class="n">bwv84_5</span><span class="p">)</span>

<div class="viewcode-block" id="addMomentsToScore"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.addMomentsToScore">[docs]</a><span class="k">def</span> <span class="nf">addMomentsToScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">forceAdd</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Adds :class:`Moment` objects to a :class:`~music21.stream.Score`.</span>
<span class="sd">    Without them, the :meth:`Database.addScore` method will not </span>
<span class="sd">    be able to add vertical note relationships to the database, such as</span>
<span class="sd">    `NoteSimultaneousWithNote`, `NoteStartsAtMoment`, and `NoteSustainedAtMoment`.</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; from music21 import *</span>
<span class="sd">    &gt;&gt;&gt; bwv84_5 = corpus.parse(&#39;bach/bwv84.5.mxl&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print len(bwv84_5)</span>
<span class="sd">    6</span>
<span class="sd">    &gt;&gt;&gt; from music21.musicNet import *</span>
<span class="sd">    &gt;&gt;&gt; addMomentsToScore(bwv84_5)</span>
<span class="sd">    &gt;&gt;&gt; print len(bwv84_5)</span>
<span class="sd">    71</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">score</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;Moment&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">forceAdd</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;This score already has Moments. &#39;</span><span class="p">,</span>
                             <span class="s">&#39;Use the forceAdd=True argument to override.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="n">attackLookup</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">addNotesFromStream</span><span class="p">(</span><span class="n">attackLookup</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>    
    <span class="n">attackOffsets</span> <span class="o">=</span> <span class="n">attackLookup</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">attackOffsets</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    
    <span class="kn">import</span> <span class="nn">heapq</span>
    <span class="n">releaseOffsets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">releaseLookup</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">attackOffsets</span><span class="p">:</span>
        <span class="n">moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">()</span>
        <span class="c"># drop any sustained notes that have passed</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">releaseOffsets</span> <span class="ow">and</span> <span class="n">releaseOffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">offset</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">releaseLookup</span><span class="p">[</span><span class="n">releaseOffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">releaseOffsets</span><span class="p">)</span> <span class="c"># always returns the lowest element</span>
        <span class="c"># add any current sustained notes to the moment</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releaseOffsets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">releaseLookup</span><span class="p">[</span><span class="n">r</span><span class="p">]:</span>
                <span class="n">moment</span><span class="o">.</span><span class="n">addComponents</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">sameOffset</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c"># add any new onsets to the moment</span>
        <span class="c"># add a release reference for every note</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">attackLookup</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">:</span>
            <span class="n">moment</span><span class="o">.</span><span class="n">addComponents</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">sameOffset</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">noteReleaseOffset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">note</span><span class="o">.</span><span class="n">quarterLength</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">noteReleaseOffset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">releaseOffsets</span><span class="p">):</span>
                <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">releaseOffsets</span><span class="p">,</span> <span class="n">noteReleaseOffset</span><span class="p">)</span>
                <span class="n">releaseLookup</span><span class="p">[</span><span class="n">noteReleaseOffset</span><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakSet</span><span class="p">()</span>
            <span class="n">releaseLookup</span><span class="p">[</span><span class="n">noteReleaseOffset</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
        <span class="n">score</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">addNotesFromStream</span><span class="p">(</span><span class="n">attackLookup</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_classes</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">classes</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">offset</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">.</span><span class="n">offset</span>
    <span class="k">if</span> <span class="s">&#39;Stream&#39;</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="n">addNotesFromStream</span><span class="p">(</span><span class="n">attackLookup</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="s">&#39;Note&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c"># Add a reference to the Note indexed by offset</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attackLookup</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">attackLookup</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakSet</span><span class="p">([</span><span class="n">obj</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_signedModulo</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This modulo function will return both negative and positive numbers.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="n">val</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mod</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">-=</span> <span class="n">mod</span> <span class="o">*</span> <span class="n">sign</span>
    <span class="k">return</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">_getPy2neoMetadata</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Returns the hidden metadata of a py2neo object, </span>
<span class="sd">    the location of which can change depending on the version of Neo4j.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">_Resource__metadata</span>

<span class="k">def</span> <span class="nf">_convertFromString</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;False&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">_serverCall</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">py2neo</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">SocketError</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">break</span>
    <span class="k">return</span> <span class="n">r</span>    


<span class="c">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Database"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Database">[docs]</a><span class="k">class</span> <span class="nc">Database</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;An object that connects to a Neo4j database, imports music21 scores,</span>
<span class="sd">    and provides information about the contents of the database.</span>
<span class="sd">    </span>
<span class="sd">    By default it assumes the Neo4j database is available at the standard</span>
<span class="sd">    location on the current machine (`http://localhost:7474/db/data/`), but the</span>
<span class="sd">    `uri` argument can be used to specify a remote or non-standard location.</span>
<span class="sd">    (Note that the URI should end with a slash!) Any keyword arguments are</span>
<span class="sd">    passed on to a :class:`py2neo.neo4j.GraphDatabaseService` object.</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; db = Database()</span>
<span class="sd">    &gt;&gt;&gt; print db.graph_db</span>
<span class="sd">    GraphDatabaseService(&#39;http://localhost:7474/db/data/&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">_DOC_ORDER</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;wipeDatabase&#39;</span><span class="p">,</span> <span class="s">&#39;addScore&#39;</span><span class="p">,</span> <span class="s">&#39;listScores&#39;</span><span class="p">,</span> <span class="s">&#39;listNodeTypes&#39;</span><span class="p">,</span> <span class="s">&#39;listNodeProperties&#39;</span><span class="p">,</span> 
                   <span class="s">&#39;listRelationshipTypes&#39;</span><span class="p">,</span> <span class="s">&#39;listRelationshipProperties&#39;</span><span class="p">,</span> <span class="s">&#39;addPropertyCallback&#39;</span> <span class="p">]</span>
    <span class="n">_DOC_ATTR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;graph_db&#39;</span><span class="p">:</span> <span class="s">&#39;The instance of a :class:`py2neo.neo4j.GraphDatabaseService` object connected to this object, which is in turn connected to a Neo4j server either at the default location on the present computer, or the one specified by the Database `uri` argument.&#39;</span><span class="p">,</span>             
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="s">&#39;http://localhost:7474/db/data/&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span> <span class="o">=</span> <span class="n">py2neo</span><span class="o">.</span><span class="n">neo4j</span><span class="o">.</span><span class="n">GraphDatabaseService</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">py2neo</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">SocketError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;Unable to connect to database.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defaultCallbacks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_m21SuperclassLookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inspectMusic21ExpressionsArticulations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skipProperties</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;_activeSite&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;_classes&#39;</span><span class="p">,</span> <span class="s">&#39;groups&#39;</span><span class="p">,</span> <span class="s">&#39;sites&#39;</span><span class="p">,</span>
                               <span class="s">&#39;_derivation&#39;</span><span class="p">,</span> <span class="s">&#39;_overriddenLily&#39;</span><span class="p">,</span> <span class="s">&#39;_definedContexts&#39;</span><span class="p">,</span> <span class="s">&#39;_activeSiteId&#39;</span><span class="p">,</span> 
                               <span class="s">&#39;_idLastDeepCopyOf&#39;</span><span class="p">,</span> <span class="s">&#39;_mutable&#39;</span><span class="p">,</span> <span class="s">&#39;_elements&#39;</span><span class="p">,</span> <span class="s">&#39;_cache&#39;</span><span class="p">,</span> <span class="s">&#39;isFlat&#39;</span><span class="p">,</span> 
                               <span class="s">&#39;autosort&#39;</span><span class="p">,</span> <span class="s">&#39;_components&#39;</span><span class="p">,</span> <span class="s">&#39;_unlinkedDuration&#39;</span><span class="p">,</span> <span class="s">&#39;isSorted&#39;</span><span class="p">,</span> 
                               <span class="s">&#39;flattenedRepresentationOf&#39;</span><span class="p">,</span> <span class="s">&#39;_reprHead&#39;</span><span class="p">,</span> <span class="s">&#39;idLocal&#39;</span><span class="p">,</span> <span class="s">&#39;autoSort&#39;</span><span class="p">,</span>
                               <span class="s">&#39;inherited&#39;</span><span class="p">,</span> <span class="s">&#39;_fullyQualifiedClasses&#39;</span><span class="p">,</span> <span class="s">&#39;filePath&#39;</span><span class="p">,</span> <span class="s">&#39;fileFormat&#39;</span><span class="p">,</span> <span class="s">&#39;fileNumber&#39;</span><span class="p">)</span> 

<div class="viewcode-block" id="Database.wipeDatabase"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Database.wipeDatabase">[docs]</a>    <span class="k">def</span> <span class="nf">wipeDatabase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Removes all relationships and nodes from the database.</span>

<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; db.wipeDatabase()</span>
<span class="sd">        &gt;&gt;&gt; print db.graph_db.get_relationship_count()</span>
<span class="sd">        0</span>
<span class="sd">        &gt;&gt;&gt; print db.graph_db.get_node_count()</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; bwv84_5 = corpus.parse(&#39;bach/bwv84.5.mxl&#39;)  #_DOCS_HIDE</span>
<span class="sd">        &gt;&gt;&gt; addMomentsToScore(bwv84_5)                  #_DOCS_HIDE</span>
<span class="sd">        &gt;&gt;&gt; db.addScore(bwv84_5)                        #_DOCS_HIDE</span>

<span class="sd">        The node count can never go below 1 because Neo4j always keeps a reference node </span>
<span class="sd">        in its network graph.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">setStartRelationship</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">_serverCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">get_relationship_count</span><span class="p">)):</span>
            <span class="n">results</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">_serverCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">delete</span><span class="p">,</span> <span class="o">*</span><span class="n">results</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">setStartNode</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">_serverCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">get_node_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">results</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">_serverCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">delete</span><span class="p">,</span> <span class="o">*</span><span class="n">results</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Database.addScore"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Database.addScore">[docs]</a>    <span class="k">def</span> <span class="nf">addScore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a music21 :class:`~music21.stream.Score` to the database.</span>
<span class="sd">        In case the score does not contain :class:`~music21.metadata.Metadata` information</span>
<span class="sd">        about the name of the score. To see progress on the import, we can set the </span>
<span class="sd">        `verbose` argument to `True`.</span>
<span class="sd">        </span>
<span class="sd">        In order to be able to access vertical note relationships such as</span>
<span class="sd">        `NoteSimultaneousWithNote`, `NoteStartsAtMoment`, and `NoteSustainedAtMoment`,</span>
<span class="sd">        we need to add :class:`Moment` objects to the score using the </span>
<span class="sd">        module-level :meth:`addMomentsToScore` method before calling this method.</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; db.wipeDatabase() #_DOCS_HIDE</span>
<span class="sd">        &gt;&gt;&gt; bwv84_5 = corpus.parse(&#39;bach/bwv84.5.mxl&#39;)</span>
<span class="sd">        &gt;&gt;&gt; addMomentsToScore(bwv84_5)</span>
<span class="sd">        &gt;&gt;&gt; db.addScore(bwv84_5)</span>
<span class="sd">        &gt;&gt;&gt; print db.graph_db.get_node_count()</span>
<span class="sd">        457</span>
<span class="sd">        &gt;&gt;&gt; print db.graph_db.get_relationship_count()</span>
<span class="sd">        1517</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c">#        self.nodeLookup = {}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;verbose&#39;</span><span class="p">:</span> <span class="n">verbose</span><span class="p">,</span>
                              <span class="s">&#39;nodeCnt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s">&#39;relationCnt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s">&#39;nodeLookup&#39;</span><span class="p">:</span> <span class="p">{}</span> <span class="p">}</span> <span class="c">#vertex, parent, voice</span>
        <span class="kn">import</span> <span class="nn">copy</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastProgress</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeUpdate</span><span class="p">(</span><span class="n">report</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;partItemMax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">score</span><span class="o">.</span><span class="n">parts</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Extracting music21 objects..........&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extractNodes</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_writeNodesToDatabase</span><span class="p">()</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_writeEdgesToDatabase</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Database.listScores"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Database.listScores">[docs]</a>    <span class="k">def</span> <span class="nf">listScores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a list of dict objects with information about the scores that have been added </span>
<span class="sd">        to the database, with keys for `movementName` and `_names` (a list of </span>
<span class="sd">        contributor/composer names).</span>

<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; expectedScore = [(u&#39;_names&#39;, [None]), (u&#39;corpusFilepath&#39;, u&#39;bach/bwv84.5.mxl&#39;), (u&#39;movementName&#39;, u&#39;bwv84.5.mxl&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; scores = db.listScores()</span>
<span class="sd">        &gt;&gt;&gt; sorted(scores[0].items()) == expectedScore</span>
<span class="sd">        True</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">setStartNode</span><span class="p">(</span><span class="n">nodeType</span><span class="o">=</span><span class="s">&#39;Score&#39;</span><span class="p">)</span>
        <span class="n">inScore</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="s">&#39;MetadataInScore&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">score</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">inScore</span><span class="o">.</span><span class="n">start</span>
        <span class="n">inMetadata</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="s">&#39;ContributorInMetaData&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">contributor</span> <span class="o">=</span> <span class="n">inMetadata</span><span class="o">.</span><span class="n">start</span>
        <span class="n">q</span><span class="o">.</span><span class="n">addReturns</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">movementName</span><span class="p">,</span> <span class="n">contributor</span><span class="o">.</span><span class="n">_names</span><span class="p">,</span> <span class="n">score</span><span class="o">.</span><span class="n">corpusFilepath</span><span class="p">)</span>
        <span class="n">results</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)):</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                    <span class="n">scores</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">score</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s">&#39;_names&#39;</span><span class="p">:</span>
                    <span class="n">score</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">score</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Database.listNodeTypes"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Database.listNodeTypes">[docs]</a>    <span class="k">def</span> <span class="nf">listNodeTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a set of node types available in the database.</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; nTypes = db.listNodeTypes()</span>
<span class="sd">        &gt;&gt;&gt; print &#39;Instrument&#39; in nTypes</span>
<span class="sd">        True</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;nTypes&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listRelationshipTypes</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span>
</div>
<div class="viewcode-block" id="Database.listNodeProperties"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Database.listNodeProperties">[docs]</a>    <span class="k">def</span> <span class="nf">listNodeProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a list of node properties in the database, represented as tuples</span>
<span class="sd">        (node type, property name).</span>
<span class="sd">        </span>
<span class="sd">        For instance, to see what properties are available in score nodes:</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; props = db.listNodeProperties()</span>
<span class="sd">        &gt;&gt;&gt; print sorted( [x for x in props if x[0]==&#39;Score&#39;] )</span>
<span class="sd">        [(u&#39;Score&#39;, u&#39;_atSoundingPitch&#39;), (u&#39;Score&#39;, u&#39;_priority&#39;), (u&#39;Score&#39;, u&#39;corpusFilepath&#39;), (u&#39;Score&#39;, u&#39;hideObjectOnPrint&#39;), (u&#39;Score&#39;, u&#39;offset&#39;)]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;nodeProperties&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeProperties</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;nTypes&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listNodeTypes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeProperties</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nodeType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span><span class="p">:</span>
            <span class="n">q</span><span class="o">.</span><span class="n">setStartNode</span><span class="p">(</span><span class="n">nodeType</span><span class="o">=</span><span class="n">nodeType</span><span class="p">)</span>
            <span class="n">results</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">_serverCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">get_properties</span><span class="p">,</span> <span class="o">*</span><span class="n">results</span><span class="p">)</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s">&#39;type&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodeProperties</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nodeType</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeProperties</span>
    </div>
<div class="viewcode-block" id="Database.listRelationshipTypes"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Database.listRelationshipTypes">[docs]</a>    <span class="k">def</span> <span class="nf">listRelationshipTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a list of relationship types in the database, represented as </span>
<span class="sd">        dict objects with keys for `start`, `type`, and `end`. By convention,</span>
<span class="sd">        starts and ends in relationships read as a right-directed arrow::</span>
<span class="sd">        </span>
<span class="sd">            Start--Relationship--&gt;End</span>
<span class="sd">            </span>
<span class="sd">        For instance, to see if any of the scores in the database </span>
<span class="sd">        have `MetadataInScore` relationships (let&#39;s hope they do!), we could do this:</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; rTypes = db.listRelationshipTypes()</span>
<span class="sd">        &gt;&gt;&gt; print [x[&#39;type&#39;] for x in rTypes if x[&#39;type&#39;]==&#39;MetadataInScore&#39;]</span>
<span class="sd">        [u&#39;MetadataInScore&#39;]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;rTypes&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rTypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rTypes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">rTypes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">relateTypes</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">while</span> <span class="ow">not</span> <span class="n">relateTypes</span><span class="p">:</span>
            <span class="n">relateTypes</span> <span class="o">=</span> <span class="n">_serverCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">get_relationship_types</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">relateType</span> <span class="ow">in</span> <span class="n">relateTypes</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">setStartRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="n">relateType</span><span class="p">)</span>
            <span class="n">q</span><span class="o">.</span><span class="n">addReturns</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="n">results</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">rTypes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">relateType</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nTypes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">end</span>  <span class="ow">in</span> <span class="n">rTypes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span> <span class="s">&#39;start&#39;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s">&#39;end&#39;</span><span class="p">:</span> <span class="n">end</span> <span class="p">}</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rTypes</span>
    </div>
<div class="viewcode-block" id="Database.listRelationshipProperties"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Database.listRelationshipProperties">[docs]</a>    <span class="k">def</span> <span class="nf">listRelationshipProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a list of relationship properties in the database, represented as tuples</span>
<span class="sd">         (relationship type,  property name).</span>
<span class="sd">        </span>
<span class="sd">        For instance, to see what properties are available in `NoteSimultaneousWithNote`</span>
<span class="sd">        relationships:</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; rProps = db.listRelationshipProperties()</span>
<span class="sd">        &gt;&gt;&gt; print sorted( [x for x in rProps if x[0]==&#39;NoteSimultaneousWithNote&#39;] )</span>
<span class="sd">        [(u&#39;NoteSimultaneousWithNote&#39;, u&#39;harmonicInterval&#39;), (u&#39;NoteSimultaneousWithNote&#39;, u&#39;sameOffset&#39;), (u&#39;NoteSimultaneousWithNote&#39;, u&#39;simpleHarmonicInterval&#39;)]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;relateProperties&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relateProperties</span>
        <span class="n">rTypes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listRelationshipTypes</span><span class="p">():</span>
            <span class="n">rTypes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">])</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">relateProperties</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rType</span> <span class="ow">in</span> <span class="n">rTypes</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">q</span><span class="o">.</span><span class="n">setStartRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="n">rType</span><span class="p">)</span>
            <span class="n">results</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">_serverCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">get_properties</span><span class="p">,</span> <span class="o">*</span><span class="n">results</span><span class="p">)</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">relate</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">relate</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">relateProperties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">rType</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relateProperties</span>
</div>
<div class="viewcode-block" id="Database.addPropertyCallback"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Database.addPropertyCallback">[docs]</a>    <span class="k">def</span> <span class="nf">addPropertyCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;**For advanced use only.**</span>
<span class="sd">        </span>
<span class="sd">        All music21 objects have default handling when being imported. When</span>
<span class="sd">        default handling isn&#39;t enough, one or more callbacks can be added to</span>
<span class="sd">        preprocess the object, or prevent it from being added to the database.</span>
<span class="sd">        The `entity` argument is the class name the callback should be added to</span>
<span class="sd">        (as a string), and the `callback` argument is a function object to be</span>
<span class="sd">        called. Multiple callbacks can be added to the same class, and an object</span>
<span class="sd">        can have callbacks for multiple classes (for instance, a trill will have</span>
<span class="sd">        callbacks for both &#39;Trill&#39; and &#39;Expression&#39;). Built-in callbacks are set </span>
<span class="sd">        in the internal :meth:`_defaultCallbacks` method.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_defaultCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">HIDEFROMDATABASE</span> <span class="o">=</span> <span class="mi">1</span>
                
        <span class="c"># Contributor</span>
        <span class="k">def</span> <span class="nf">addTextToContributor</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">contributor</span><span class="p">):</span>
            <span class="n">contributor</span><span class="o">.</span><span class="n">_names</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">contributor</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Contributor&#39;</span><span class="p">,</span> <span class="n">addTextToContributor</span><span class="p">)</span>
        
        <span class="c"># Part</span>
        <span class="k">def</span> <span class="nf">addPartNumber</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
            <span class="n">nodeLookup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">part</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">part</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">vertex</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">part</span><span class="p">][</span><span class="s">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;NoteToNote&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s">&#39;NoteToNoteByBeat&#39;</span><span class="p">:</span> <span class="p">{}</span> <span class="p">}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;clef&#39;</span><span class="p">,</span> <span class="s">&#39;timeSignature&#39;</span><span class="p">,</span> <span class="s">&#39;keySignatureSharps&#39;</span><span class="p">,</span> <span class="s">&#39;keySignatureMode&#39;</span><span class="p">):</span>
                <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Part&#39;</span><span class="p">,</span> <span class="n">addPartNumber</span><span class="p">)</span>
                
        <span class="c"># Measure</span>
        <span class="k">def</span> <span class="nf">addSignaturesAndClefs</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">measure</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">measure</span><span class="o">.</span><span class="n">clef</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;clef&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">clef</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vertex</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">][</span><span class="n">measure</span><span class="p">][</span><span class="s">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;clef&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;clef&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">measure</span><span class="o">.</span><span class="n">timeSignature</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;timeSignature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">timeSignature</span><span class="o">.</span><span class="n">ratioString</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;timeSignature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;timeSignature&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">measure</span><span class="o">.</span><span class="n">keySignature</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;keySignatureSharps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">keySignature</span><span class="o">.</span><span class="n">sharps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;keySignatureMode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">keySignature</span><span class="o">.</span><span class="n">mode</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;keySignatureSharps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;keySignatureSharps&#39;</span><span class="p">]</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;keySignatureMode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;keySignatureMode&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Measure&#39;</span><span class="p">,</span> <span class="n">addSignaturesAndClefs</span><span class="p">)</span>            
        
        <span class="c"># Chord</span>
        <span class="k">def</span> <span class="nf">labelChordNotes</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">chordObj</span><span class="p">):</span>
            <span class="n">nodeLookup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
            <span class="n">chordObj</span><span class="o">.</span><span class="n">sortAscending</span><span class="p">(</span><span class="n">inPlace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chordObj</span><span class="p">)):</span>
                <span class="n">noteObj</span> <span class="o">=</span> <span class="n">chordObj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">nodeLookup</span><span class="p">[</span><span class="n">nodeObj</span><span class="p">][</span><span class="s">&#39;voice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chordObj</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span>
                <span class="n">nodeLookup</span><span class="p">[</span><span class="n">noteObj</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">chordObj</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">HIDEFROMDATABASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Chord&#39;</span><span class="p">,</span> <span class="n">labelChordNotes</span><span class="p">)</span>
        
        <span class="c"># Voice</span>
        <span class="k">def</span> <span class="nf">labelVoiceNotes</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">voice</span><span class="p">):</span>
            <span class="n">nodeLookup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">noteObj</span> <span class="ow">in</span> <span class="n">voice</span><span class="p">:</span>
                <span class="n">nodeLookup</span><span class="p">[</span><span class="n">noteObj</span><span class="p">][</span><span class="s">&#39;voice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">voice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">nodeLookup</span><span class="p">[</span><span class="n">noteObj</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">voice</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">HIDEFROMDATABASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Voice&#39;</span><span class="p">,</span> <span class="n">labelVoiceNotes</span><span class="p">)</span>

        <span class="c"># Note</span>
        <span class="k">def</span> <span class="nf">addNoteVoiceleading</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">noteObj</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">addVoiceleading</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">noteObj</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">noteObj</span><span class="o">.</span><span class="n">isRest</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">history</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;history&#39;</span><span class="p">]</span>
                <span class="n">nodeLookup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
                <span class="n">voice</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">noteObj</span><span class="p">][</span><span class="s">&#39;voice&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prevNote</span><span class="p">,</span> <span class="n">prevOffset</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">relationship</span><span class="p">][</span><span class="n">voice</span><span class="p">]</span>
                    <span class="n">voiceleadingHistory</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">voiceleadingHistory</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c"># Only calculate voiceleading for notes within the span of a measure.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">voiceleadingHistory</span> <span class="ow">and</span> 
                        <span class="n">offset</span> <span class="o">-</span> <span class="n">prevOffset</span> <span class="o">&lt;=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">noteObj</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">barDuration</span><span class="p">):</span>
                    <span class="n">mint</span> <span class="o">=</span> <span class="n">noteObj</span><span class="o">.</span><span class="n">midi</span> <span class="o">-</span> <span class="n">prevNote</span><span class="o">.</span><span class="n">midi</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">_addEdge</span><span class="p">(</span><span class="n">prevNote</span><span class="p">,</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">noteObj</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;interval&#39;</span><span class="p">:</span> <span class="n">mint</span> <span class="p">}</span> <span class="p">)</span>
                <span class="n">history</span><span class="p">[</span><span class="n">relationship</span><span class="p">][</span><span class="n">voice</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">noteObj</span><span class="p">,</span> <span class="n">offset</span><span class="p">]</span>
            
            <span class="n">nodeLookup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">noteObj</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">noteObj</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">if</span> <span class="s">&#39;voice&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">noteObj</span><span class="p">]:</span>
                <span class="n">nodeLookup</span><span class="p">[</span><span class="n">noteObj</span><span class="p">][</span><span class="s">&#39;voice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">addVoiceleading</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;NoteToNote&#39;</span><span class="p">,</span> <span class="n">noteObj</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">noteObj</span><span class="o">.</span><span class="n">offset</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">addVoiceleading</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;NoteToNoteByBeat&#39;</span><span class="p">,</span> <span class="n">noteObj</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Note&#39;</span><span class="p">,</span> <span class="n">addNoteVoiceleading</span><span class="p">)</span>

        <span class="c"># Pitch</span>
        <span class="k">def</span> <span class="nf">addPitchToNote</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">pitchObj</span><span class="p">):</span>
            <span class="n">nodeLookup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
            <span class="n">noteObj</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">pitchObj</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span>
            <span class="n">vertex</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">noteObj</span><span class="p">][</span><span class="s">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;pitch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pitchObj</span><span class="o">.</span><span class="n">nameWithOctave</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;midi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pitchObj</span><span class="o">.</span><span class="n">midi</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;microtone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pitchObj</span><span class="o">.</span><span class="n">microtone</span><span class="o">.</span><span class="n">cents</span>
            <span class="k">return</span> <span class="n">HIDEFROMDATABASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Pitch&#39;</span><span class="p">,</span> <span class="n">addPitchToNote</span><span class="p">)</span>

        <span class="c"># Duration</span>
        <span class="k">def</span> <span class="nf">addDurationToParent</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">durationObj</span><span class="p">):</span>
            <span class="n">nodeLookup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">durationObj</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span>
            <span class="n">parentType</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
            <span class="n">vertex</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="s">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parentType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;StaffGroup&#39;</span><span class="p">,</span> <span class="s">&#39;Instrument&#39;</span><span class="p">,</span> <span class="s">&#39;Metadata&#39;</span><span class="p">):</span>
                <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;quarterLength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">durationObj</span><span class="o">.</span><span class="n">quarterLength</span>
            <span class="k">if</span> <span class="n">parentType</span> <span class="o">==</span> <span class="s">&#39;Note&#39;</span><span class="p">:</span>
                <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;isGrace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">durationObj</span><span class="o">.</span><span class="n">isGrace</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">durationObj</span><span class="p">,</span> <span class="s">&#39;stealTimePrevious&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;stealTimePrevious&#39;</span><span class="p">,</span> <span class="s">&#39;stealTimeFollowing&#39;</span><span class="p">,</span> <span class="s">&#39;slash&#39;</span><span class="p">):</span>
                        <span class="n">vertex</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">durationObj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HIDEFROMDATABASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Duration&#39;</span><span class="p">,</span> <span class="n">addDurationToParent</span><span class="p">)</span>
        
        <span class="c"># MetronomeMark</span>
        <span class="k">def</span> <span class="nf">simplifyText</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">mm</span><span class="p">):</span>
            <span class="n">mm</span><span class="o">.</span><span class="n">_tempoText</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">_tempoText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;MetronomeMark&#39;</span><span class="p">,</span> <span class="n">simplifyText</span><span class="p">)</span>
        
        <span class="c"># Expression, Articulation</span>
        <span class="k">def</span> <span class="nf">useAbstractType</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
            <span class="n">abstractions</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Expression&#39;</span><span class="p">,</span> <span class="s">&#39;Articulation&#39;</span><span class="p">)</span>
            <span class="n">superclass</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">classes</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">abstractions</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vertex</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">][</span><span class="n">obj</span><span class="p">][</span><span class="s">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">superclass</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Expression&#39;</span><span class="p">,</span> <span class="n">useAbstractType</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Articulation&#39;</span><span class="p">,</span> <span class="n">useAbstractType</span><span class="p">)</span>

        <span class="c"># Trill, Mordent, Turn, Schleifer</span>
        <span class="k">def</span> <span class="nf">simplifyOrnamentInterval</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ornament</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ornament</span><span class="p">,</span> <span class="s">&#39;size&#39;</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ornament</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
                <span class="n">ornament</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">ornament</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">directedName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Trill&#39;</span><span class="p">,</span> <span class="n">simplifyOrnamentInterval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;GeneralMordent&#39;</span><span class="p">,</span> <span class="n">simplifyOrnamentInterval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Turn&#39;</span><span class="p">,</span> <span class="n">simplifyOrnamentInterval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Schleifer&#39;</span><span class="p">,</span> <span class="n">simplifyOrnamentInterval</span><span class="p">)</span>

        <span class="c"># Beams</span>
        <span class="k">def</span> <span class="nf">addBeams</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">beams</span><span class="p">):</span>
            <span class="n">nodeLookup</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
            <span class="n">noteObj</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">beams</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="o">.</span><span class="n">beamsList</span><span class="p">:</span>
                <span class="n">nodeLookup</span><span class="p">[</span><span class="n">beam</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;parent&#39;</span><span class="p">:</span> <span class="n">noteObj</span> <span class="p">}</span>
                <span class="n">db</span><span class="o">.</span><span class="n">_addNode</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HIDEFROMDATABASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Beams&#39;</span><span class="p">,</span> <span class="n">addBeams</span><span class="p">)</span>
        
        <span class="c"># Clef</span>
        <span class="k">def</span> <span class="nf">addMidmeasureClefs</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">clefObj</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">clefObj</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HIDEFROMDATABASE</span>
            <span class="n">vertex</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">][</span><span class="n">clefObj</span><span class="p">][</span><span class="s">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;MidmeasureClef&#39;</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clefObj</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Clef&#39;</span><span class="p">,</span> <span class="n">addMidmeasureClefs</span><span class="p">)</span>
        
        <span class="c"># Moment</span>
        <span class="k">def</span> <span class="nf">addCrossPartRelationships</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">moment</span><span class="p">):</span>
            <span class="n">simultaneous</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">moment</span><span class="o">.</span><span class="n">simultaneous</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">noteObj</span> <span class="ow">in</span> <span class="n">simultaneous</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">_addEdge</span><span class="p">(</span><span class="n">noteObj</span><span class="p">,</span> <span class="s">&#39;NoteSustainedAtMoment&#39;</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
            <span class="n">sameOffset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">moment</span><span class="o">.</span><span class="n">sameOffset</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">noteObj</span> <span class="ow">in</span> <span class="n">sameOffset</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">_addEdge</span><span class="p">(</span><span class="n">noteObj</span><span class="p">,</span> <span class="s">&#39;NoteStartsAtMoment&#39;</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">sameOffset</span> <span class="o">+</span> <span class="n">simultaneous</span>
            <span class="n">simuls</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">note1</span> <span class="o">=</span> <span class="n">notes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">notes</span><span class="p">)):</span>
                    <span class="n">note2</span> <span class="o">=</span> <span class="n">notes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">note1</span> <span class="ow">in</span> <span class="n">simuls</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">note2</span> <span class="ow">in</span> <span class="n">simuls</span><span class="p">[</span><span class="n">note1</span><span class="p">]:</span> <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">simuls</span><span class="p">[</span><span class="n">note1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">note2</span> <span class="ow">in</span> <span class="n">simuls</span> <span class="ow">and</span> <span class="n">note1</span> <span class="ow">in</span> <span class="n">simuls</span><span class="p">[</span><span class="n">note2</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="n">simuls</span><span class="p">[</span><span class="n">note1</span><span class="p">][</span><span class="n">note2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">cInt</span> <span class="o">=</span> <span class="n">note1</span><span class="o">.</span><span class="n">midi</span> <span class="o">-</span> <span class="n">note2</span><span class="o">.</span><span class="n">midi</span>
                    <span class="n">sInt</span> <span class="o">=</span> <span class="n">_signedModulo</span><span class="p">(</span><span class="n">note1</span><span class="o">.</span><span class="n">midi</span> <span class="o">-</span> <span class="n">note2</span><span class="o">.</span><span class="n">midi</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
                    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;harmonicInterval&#39;</span><span class="p">:</span> <span class="n">cInt</span><span class="p">,</span>
                                   <span class="s">&#39;simpleHarmonicInterval&#39;</span><span class="p">:</span> <span class="n">sInt</span><span class="p">,</span>
                                   <span class="s">&#39;sameOffset&#39;</span><span class="p">:</span> <span class="s">&#39;False&#39;</span> <span class="p">}</span>
                    <span class="k">if</span> <span class="n">note1</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">note2</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
                        <span class="n">properties</span><span class="p">[</span><span class="s">&#39;sameOffset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;True&#39;</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">_addEdge</span><span class="p">(</span><span class="n">note1</span><span class="p">,</span> <span class="s">&#39;NoteSimultaneousWithNote&#39;</span><span class="p">,</span> <span class="n">note2</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Moment&#39;</span><span class="p">,</span> <span class="n">addCrossPartRelationships</span><span class="p">)</span>
        
        <span class="c"># Spanner</span>
        <span class="k">def</span> <span class="nf">addSpannerRelationship</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
<span class="c">#            if kind == &#39;Moment&#39;: return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">span</span><span class="o">.</span><span class="n">getSpannedElements</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;StaffGroup&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">span</span><span class="p">)):</span>
                        <span class="n">part</span> <span class="o">=</span> <span class="n">span</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">_addEdge</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="s">&#39;PartInStaffGroup&#39;</span><span class="p">,</span> <span class="n">span</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;Slur&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Handling of &quot;</span><span class="si">%s</span><span class="s">&quot; Spanners is not supported.&#39;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">)</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">getFirst</span><span class="p">()</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">getLast</span><span class="p">()</span>
            <span class="n">span</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kind</span>
            <span class="c"># music21 1.0 handling of gracenote slurs is broken, therefore:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">measureNumber</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">last</span><span class="o">.</span><span class="n">measureNumber</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">db</span><span class="o">.</span><span class="n">_addEdge</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="s">&#39;spannerTo&#39;</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">span</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HIDEFROMDATABASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;Spanner&#39;</span><span class="p">,</span> <span class="n">addSpannerRelationship</span><span class="p">)</span>

        <span class="c"># Optional objects</span>
        <span class="c"># NoteEditorial</span>
        <span class="k">def</span> <span class="nf">skipIfEmpty</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
            <span class="n">objDict</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">objDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skipProperties</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;position&#39;</span><span class="p">:</span>
                    <span class="k">continue</span> <span class="c"># There are empty objects with non-empty positions.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&#39;__dict__&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">skipIfEmpty</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="k">continue</span>
                <span class="k">return</span>
            <span class="k">return</span> <span class="n">HIDEFROMDATABASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;NoteEditorial&#39;</span><span class="p">,</span> <span class="n">skipIfEmpty</span><span class="p">)</span>
        
        <span class="c"># Omitted objects</span>
        <span class="c"># TimeSignature, KeySignature, MiscTandam</span>
        <span class="k">def</span> <span class="nf">skipThisObject</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">HIDEFROMDATABASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;TimeSignature&#39;</span><span class="p">,</span> <span class="n">skipThisObject</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;KeySignature&#39;</span><span class="p">,</span> <span class="n">skipThisObject</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPropertyCallback</span><span class="p">(</span><span class="s">&#39;MiscTandam&#39;</span><span class="p">,</span> <span class="n">skipThisObject</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_inspectMusic21ExpressionsArticulations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">inspect</span>
        <span class="n">lookup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># search music21 modules:</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">articulations</span><span class="p">):</span>
            <span class="n">sName</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">__name__</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cName</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
                <span class="n">lookup</span><span class="p">[</span><span class="n">cName</span><span class="p">]</span> <span class="o">=</span> <span class="n">sName</span>
        <span class="k">return</span> <span class="n">lookup</span>

    <span class="k">def</span> <span class="nf">_timeUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">newtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(</span><span class="si">%.1f</span><span class="s"> seconds)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newtime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">refTime</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refTime</span> <span class="o">=</span> <span class="n">newtime</span>

    <span class="k">def</span> <span class="nf">_progressReport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">minIn</span><span class="p">,</span> <span class="n">maxIn</span><span class="p">,</span> <span class="n">minOut</span><span class="p">,</span> <span class="n">maxOut</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;lastProgress&#39;</span><span class="p">):</span>
            <span class="n">lastOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastProgress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lastOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastProgress</span>
        <span class="n">rangeIn</span> <span class="o">=</span> <span class="n">maxIn</span> <span class="o">-</span> <span class="n">minIn</span>
        <span class="n">rangeOut</span> <span class="o">=</span> <span class="n">maxOut</span> <span class="o">-</span> <span class="n">minOut</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">rangeOut</span> <span class="o">*</span> <span class="p">(</span><span class="n">state</span> <span class="o">-</span> <span class="n">minIn</span><span class="p">)</span> <span class="o">/</span> <span class="n">rangeIn</span> <span class="o">+</span> <span class="n">minOut</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">progress</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress</span> <span class="o">&gt;=</span> <span class="n">lastOut</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">30.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">/</span> <span class="n">rangeOut</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;=&#39;</span> <span class="o">*</span> <span class="n">increment</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastProgress</span> <span class="o">=</span> <span class="n">progress</span>
    
    <span class="k">def</span> <span class="nf">_extractNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Put all the hierarchical nodes and their relationships into linear order.</span>
<span class="sd">        At this point relationships store references to the original music21 objects.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span>
        <span class="n">nodeLookup</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
<span class="c">#        print obj.__class__.__name__</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodeLookup</span><span class="p">:</span>
            <span class="n">nodeLookup</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;parent&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">obj</span><span class="p">]):</span>
            <span class="n">nodeLookup</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;Part&#39;</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s">&#39;partItemCnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;partItemCnt&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progressReport</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;partItemCnt&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;partItemMax&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addNode</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;classes&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;Spanner&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;Moment&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">itemList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">itemList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extractNodes</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_addNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">nodeLookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
        <span class="n">vertex</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s">&#39;vertex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">kind</span> <span class="p">}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&#39;offset&#39;</span><span class="p">):</span>
            <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runCallbacks</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="k">if</span> <span class="s">&#39;parent&#39;</span> <span class="ow">in</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span>
            <span class="n">parentvertex</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="s">&#39;vertex&#39;</span><span class="p">]</span>
            <span class="n">relation</span> <span class="o">=</span> <span class="n">vertex</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;In&#39;</span> <span class="o">+</span> <span class="n">parentvertex</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addEdge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;Spanner&#39;</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&#39;_classes&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;Moment&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extractObject</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_addEdge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">propertyNode</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">propertyNode</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="n">propertyNode</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">propertyNode</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">Music21Object</span><span class="p">):</span> <span class="c"># in case of Spanners</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extractObject</span><span class="p">(</span><span class="n">propertyNode</span><span class="p">)</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">][</span><span class="n">propertyNode</span><span class="p">][</span><span class="s">&#39;vertex&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">properties</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="p">[</span> <span class="n">start</span><span class="p">,</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">properties</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
    
<span class="c">#    def _editNode(self, item, key, value):</span>
<span class="c">#        idx = self.nodeLookup[item]</span>
<span class="c">#        node = self.nodes[idx]</span>
<span class="c">#        if value == None:</span>
<span class="c">#            value = &#39;None&#39;</span>
<span class="c">#        node().vertex[key] = value</span>
        
    <span class="k">def</span> <span class="nf">_runCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&#39;classes&#39;</span><span class="p">):</span>
            <span class="n">kinds</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">classes</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">kinds</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m21SuperclassLookup</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">kinds</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">kinds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">[</span><span class="n">kind</span><span class="p">]:</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">rc</span>

    <span class="k">def</span> <span class="nf">_extractObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;Moment&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">objectDict</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="n">vertex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">][</span><span class="n">obj</span><span class="p">][</span><span class="s">&#39;vertex&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">objectDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skipProperties</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;_duration&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;__dict__&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_extractNodes</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="n">vertex</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">music21</span><span class="o">.</span><span class="n">musicxml</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">MusicXMLElement</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&#39;__dict__&#39;</span><span class="p">):</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">_extractNodes</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;type&#39;</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;m21_&#39;</span> <span class="o">+</span> <span class="n">key</span>
            <span class="n">vertex</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vertex</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">vertex</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    
    <span class="k">def</span> <span class="nf">_writeNodesToDatabase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        When nodes are written to the database in order, </span>
<span class="sd">        references to their database entries will be returned in the same order.</span>
<span class="sd">        Those references are saved as attributes in the original nodes.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">batchSize</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeUpdate</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Writing nodes to database...........&#39;</span><span class="p">)</span>
            <span class="n">maxNodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nodeLookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">):</span>
<span class="c">#        while self.nodes:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">batchSize</span><span class="p">]</span>
<span class="c">#            del self.nodes[:batchSize]</span>
            <span class="n">batchLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodeLookup</span><span class="p">[</span><span class="n">x</span><span class="p">()][</span><span class="s">&#39;vertex&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">subset</span><span class="p">]</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">_serverCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">create</span><span class="p">,</span> <span class="o">*</span><span class="n">vertices</span><span class="p">)</span>
            <span class="c"># Store a nodeRef reference for each music21 object </span>
            <span class="c"># with the address of its corresponding Neo4j node.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batchLen</span><span class="p">):</span>
                <span class="n">nodeLookup</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="n">i</span><span class="p">]()][</span><span class="s">&#39;nodeRef&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeCnt&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">batchLen</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">cnt</span> <span class="o">+=</span> <span class="n">batchLen</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_progressReport</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxNodes</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">85</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">batchSize</span>
        
    <span class="k">def</span> <span class="nf">_writeEdgesToDatabase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Before relationships are written to the database, music21 object references are converted </span>
<span class="sd">        to their corresponding database nodes.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">batchSize</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="n">nodeLookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;nodeLookup&#39;</span><span class="p">]</span>
        <span class="n">edgeRefs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">ref1</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s">&#39;nodeRef&#39;</span><span class="p">]</span>
            <span class="n">ref2</span> <span class="o">=</span> <span class="n">nodeLookup</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="s">&#39;nodeRef&#39;</span><span class="p">]</span>
            <span class="n">edgeRef</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ref1</span><span class="p">,</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ref2</span> <span class="p">]</span>
            <span class="c"># Add a property dictionary, if present.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">edgeRef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">edgeRefs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edgeRef</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeUpdate</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Writing relationships to database...&#39;</span><span class="p">)</span>
            <span class="n">maxEdges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edgeRefs</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">edgeRefs</span><span class="p">):</span>
<span class="c">#        while edgeRefs:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">edgeRefs</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">batchSize</span><span class="p">]</span>
<span class="c">#            del edgeRefs[:batchSize]</span>
            <span class="n">batchLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
            <span class="n">_serverCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">create</span><span class="p">,</span> <span class="o">*</span><span class="n">subset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;relationCnt&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">batchLen</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_progressReport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extractState</span><span class="p">[</span><span class="s">&#39;relationCnt&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxEdges</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">batchSize</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeUpdate</span><span class="p">()</span>

<span class="c">#-------------------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="Query"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Query">[docs]</a><span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This object provides an interface for building and executing queries of the</span>
<span class="sd">    database. The first argument to the object must be an existing</span>
<span class="sd">    :class:`Database` object.</span>
<span class="sd">    </span>
<span class="sd">    All queries begin with a starting point, either a node or a relationship.</span>
<span class="sd">    This point is set with either the :meth:`setStartNode` or</span>
<span class="sd">    :meth:`setStartRelationship` method (but not both).  These nodes and</span>
<span class="sd">    relationships are represented by :class:`Node` and :class:`Relationship`</span>
<span class="sd">    objects, which are usually created automatically. Note that a starting point</span>
<span class="sd">    alone is a complete query structure!</span>

<span class="sd">    To get the results and metadata for a query, we use the :meth:`results`, </span>
<span class="sd">    method.</span>
<span class="sd">    </span>
<span class="sd">    Optionally, we can add a number of restrictions to the search. The</span>
<span class="sd">    :meth:`addRelationship` method allows us to connect our start node/relationship to</span>
<span class="sd">    other nodes. Any number of nodes can be connected using relationships.</span>
<span class="sd">    Each node and relationship in the database has properties, and we use them to filter</span>
<span class="sd">    our search using the :meth:`addComparisonFilter` method. </span>
<span class="sd">    </span>
<span class="sd">    By default, results are returned as references to entities in the database,</span>
<span class="sd">    which can be used by the :meth:`music21Score` method to return a music21</span>
<span class="sd">    score fragment for any result row. If we want specific data from the search,</span>
<span class="sd">    we can pass those database entities to the :meth:`getResultProperties`</span>
<span class="sd">    method to get all of their properties, we can use the :meth:`addReturns`</span>
<span class="sd">    method to specify the particular properties we&#39;re interested in.</span>
<span class="sd">    </span>
<span class="sd">    To understand what&#39;s going on behind the scenes, </span>
<span class="sd">    it may be helpful to read the documentation on the Neo4j </span>
<span class="sd">    `Cypher query language &lt;http://docs.neo4j.org/chunked/stable/cypher-query-lang.html&gt;`_.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">_DOC_ORDER</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;setStartNode&#39;</span><span class="p">,</span> <span class="s">&#39;results&#39;</span><span class="p">,</span> <span class="s">&#39;getResultProperties&#39;</span><span class="p">,</span> 
                   <span class="s">&#39;setStartRelationship&#39;</span><span class="p">,</span> <span class="s">&#39;addRelationship&#39;</span><span class="p">,</span> <span class="s">&#39;addComparisonFilter&#39;</span><span class="p">,</span> <span class="s">&#39;addCypherFilter&#39;</span><span class="p">,</span> 
                   <span class="s">&#39;addReturns&#39;</span><span class="p">,</span> <span class="s">&#39;setOrder&#39;</span><span class="p">,</span>  <span class="s">&#39;music21Score&#39;</span><span class="p">,</span> <span class="s">&#39;setObjectCallback&#39;</span> <span class="p">]</span>
    <span class="n">_DOC_ATTR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;db&#39;</span><span class="p">:</span> <span class="s">&#39;Blah&#39;</span><span class="p">,</span>
    <span class="s">&#39;results&#39;</span><span class="p">:</span> <span class="s">&#39;Blah&#39;</span><span class="p">,</span>
    <span class="s">&#39;metadata&#39;</span><span class="p">:</span> <span class="s">&#39;Blah&#39;</span><span class="p">,</span>
    <span class="s">&#39;pattern&#39;</span><span class="p">:</span> <span class="s">&#39;Blah&#39;</span><span class="p">,</span>
    <span class="s">&#39;nodes&#39;</span><span class="p">:</span> <span class="s">&#39;Blah&#39;</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constructCallbacks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returnStr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phrases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_usedNames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defaultCallbacks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inspectMusic21ExpressionsArticulations</span><span class="p">()</span>
        
<div class="viewcode-block" id="Query.setStartNode"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Query.setStartNode">[docs]</a>    <span class="k">def</span> <span class="nf">setStartNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nodeType</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nodeId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sets a starting :class:`Node` for the Query, and returns that node. </span>
<span class="sd">        Searches begin from this point and branch out to find patterns that fit the query. </span>
<span class="sd">        If we already have a Node object, that can be used as the `node` argument. </span>
<span class="sd">        </span>
<span class="sd">        Without a `node` argument a Node is created implicitly, </span>
<span class="sd">        optionally using the `nodeType` argument to specify its type. (Without a type, the</span>
<span class="sd">        node will match any type.) The list of available relationship types can be obtained</span>
<span class="sd">        from the :meth:`Database.printStructure` method.</span>
<span class="sd">        </span>
<span class="sd">        A name attribute will be randomly generated unless a `name` argument</span>
<span class="sd">        is given. There is no particular reason to name objects unless we want to control </span>
<span class="sd">        the query text exactly, however.</span>
<span class="sd">        </span>
<span class="sd">        Each node in a Neo4j database has a numeric ID. If a Node with an ID</span>
<span class="sd">        number is passed in to the `node` argument, or if a numeric `nodeId`</span>
<span class="sd">        argument is given, that ID will be used to target the search.</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; q = Query(db)</span>
<span class="sd">        &gt;&gt;&gt; print q.setStartNode(nodeType=&#39;Metadata&#39;, name=&#39;Metadata1&#39;)</span>
<span class="sd">        Metadata1</span>
<span class="sd">        </span>
<span class="sd">        Calling this method again, or calling :meth:`setStartRelationship`, will</span>
<span class="sd">        reset the start point for the Query.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodeType</span><span class="o">=</span><span class="n">nodeType</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="s">&#39;start </span><span class="si">%s</span><span class="s">=node(</span><span class="si">%d</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="s">&#39;start </span><span class="si">%s</span><span class="s">=node:node_auto_index(&quot;type:</span><span class="si">%s</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">nodeType</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="s">&#39;order by ID(</span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startId</span> <span class="o">=</span> <span class="s">&#39;ID(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> 
        <span class="k">return</span> <span class="n">node</span>
</div>
<div class="viewcode-block" id="Query.results"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Query.results">[docs]</a>    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minRow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Executes a query of the database using the current state of the Query object.</span>
<span class="sd">        Returns a tuple containing first the results, then the query metadata. </span>

<span class="sd">        The results of the query is a list of lists.</span>
<span class="sd">        If the :meth:`addReturns` method was used to specify particular </span>
<span class="sd">        properties, then each result is a list of those properties as text strings.</span>
<span class="sd">        </span>
<span class="sd">        If no return properties have been specified by the :meth:`addReturns`</span>
<span class="sd">        method, each result will be a list of :class:`py2neo.neo4j.Node` and</span>
<span class="sd">        :class:`py2neo.neo4j.Relationship` objects. In this case, a result list</span>
<span class="sd">        can be passed to :meth:`music21Score` to get a music21</span>
<span class="sd">        :class:`~music21.stream.Score` fragment containing the result. Or</span>
<span class="sd">        passing a result list to the :meth:`getResultProperties` method will add</span>
<span class="sd">        all the properties of the objects to the list.</span>
<span class="sd">        </span>
<span class="sd">        The metadata for the query is a list of the column names.</span>

<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; q = Query(db)</span>
<span class="sd">        &gt;&gt;&gt; q.setStartNode(nodeType=&#39;Score&#39;, name=&#39;Score1&#39;)</span>
<span class="sd">        Score1</span>
<span class="sd">        &gt;&gt;&gt; print q.results()</span>
<span class="sd">        ([[Node(&#39;http://localhost:7474/db/data/node/...&#39;)]], [u&#39;Score1&#39;])</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">py2neo.cypher</span> <span class="kn">as</span> <span class="nn">cypher</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assemblePattern</span><span class="p">()</span>
        <span class="n">results</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_serverCall</span><span class="p">(</span><span class="n">cypher</span><span class="o">.</span><span class="n">execute</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">graph_db</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> 
                                        <span class="p">{</span><span class="s">&#39;maxResults&#39;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span> <span class="s">&#39;minRow&#39;</span><span class="p">:</span> <span class="n">minRow</span><span class="p">})</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">metadata</span>
    </div>
<div class="viewcode-block" id="Query.getResultProperties"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Query.getResultProperties">[docs]</a>    <span class="k">def</span> <span class="nf">getResultProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Takes a list of :class:`py2neo.neo4j.Node` and</span>
<span class="sd">        :class:`py2neo.neo4j.Relationship` objects (the default result format</span>
<span class="sd">        if the :meth:`addReturns` method wasn&#39;t called), and returns a new list</span>
<span class="sd">        in which each object has been replaced by a tuple: the original object, </span>
<span class="sd">        then a dict of that object&#39;s database properties. </span>

<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; q = Query(db)</span>
<span class="sd">        &gt;&gt;&gt; score = q.setStartNode(nodeType=&#39;Score&#39;, name=&#39;Score1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; rows, meta = q.results()</span>
<span class="sd">        &gt;&gt;&gt; nodeInfo = q.getResultProperties(rows[0])[0]</span>
<span class="sd">        &gt;&gt;&gt; print sorted(nodeInfo[1].items())</span>
<span class="sd">        [(u&#39;_atSoundingPitch&#39;, u&#39;unknown&#39;), (u&#39;_priority&#39;, 0), (u&#39;corpusFilepath&#39;, u&#39;bach/bwv84.5.mxl&#39;), (u&#39;hideObjectOnPrint&#39;, False), (u&#39;offset&#39;, 0.0), (u&#39;type&#39;, u&#39;Score&#39;)]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">_serverCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">graph_db</span><span class="o">.</span><span class="n">get_properties</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Query.setStartRelationship"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Query.setStartRelationship">[docs]</a>    <span class="k">def</span> <span class="nf">setStartRelationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">relationType</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sets a starting :class:`Relationship` for the Query, and returns that relationship. </span>
<span class="sd">        Searches begin from this point and branch out to find patterns that fit the query.</span>
<span class="sd">        </span>
<span class="sd">        Without a `relation` argument a Relationship is created implicitly, </span>
<span class="sd">        optionally using the `relationType` argument to specify its type. (Without a type, the</span>
<span class="sd">        relationship will match any type.) The list of available relationship types can be</span>
<span class="sd">        obtained from the :meth:`Database.printStructure` method.</span>
<span class="sd">        </span>
<span class="sd">        The `start` and `end` arguments take :class:`Node` objects, and allow the relationship </span>
<span class="sd">        to be connected to other nodes in the query. If either is omitted, a new node object</span>
<span class="sd">        is created implicitly to fill it. By convention a relationship is understood to be </span>
<span class="sd">        a right-directed arrow::</span>
<span class="sd">        </span>
<span class="sd">            Start--Relationship--&gt;End</span>

<span class="sd">        A name attribute will be randomly generated unless </span>
<span class="sd">        a `name` argument is given. There is no particular reason to name objects or create them</span>
<span class="sd">        explicitly, unless we want to control the query text exactly.</span>

<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; q = Query(db)</span>
<span class="sd">        &gt;&gt;&gt; score = Node(q, nodeType=&#39;Score&#39;, name=&#39;Score1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; part = Node(q, &#39;Part&#39;, name=&#39;Part1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; pIS = q.setStartRelationship(relationType=&#39;PartInScore&#39;, name=&#39;PIS1&#39;, start=part, end=score)</span>
<span class="sd">        &gt;&gt;&gt; print pIS</span>
<span class="sd">        (Part1)-[PIS1:PartInScore]-&gt;(Score1)</span>
<span class="sd">        </span>
<span class="sd">        Calling this method again, or calling :meth:`setStartNode`, will</span>
<span class="sd">        reset the start point for the Query.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">relation</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">relation</span> <span class="o">=</span> <span class="n">Relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relationType</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="ow">and</span> <span class="n">relationType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;start </span><span class="si">%s</span><span class="s">=relationship:relationship_auto_index(&quot;type:</span><span class="si">%s</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&#39;</span> 
                      <span class="o">%</span> <span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">relation</span><span class="o">.</span><span class="n">relationType</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="s">&#39;order by ID(</span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">relation</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startId</span> <span class="o">=</span> <span class="s">&#39;ID(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">relation</span><span class="o">.</span><span class="n">name</span> 
        <span class="k">return</span> <span class="n">relation</span>
    </div>
<div class="viewcode-block" id="Query.addRelationship"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Query.addRelationship">[docs]</a>    <span class="k">def</span> <span class="nf">addRelationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">relationType</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a relationship to the query, and returns the corresponding</span>
<span class="sd">        :class:`Relationship` object. Any number of relationships can be added to a query.</span>

<span class="sd">        Without a Relationship object passed to the `relation` argument, a</span>
<span class="sd">        Relationship is created implicitly, optionally using the `relationType`</span>
<span class="sd">        argument to specify its type. (Without a type, the relationship will</span>
<span class="sd">        match any type.) The list of available relationship types can be</span>
<span class="sd">        obtained from the :meth:`Database.printStructure` method.</span>

<span class="sd">        The `start` and `end` arguments take :class:`Node` objects, and allow the relationship </span>
<span class="sd">        to be connected to other nodes in the query. If either is omitted, a new node object</span>
<span class="sd">        is created implicitly to fill it. By convention a relationship is understood to be </span>
<span class="sd">        a right-directed arrow::</span>
<span class="sd">        </span>
<span class="sd">            Start--Relationship--&gt;End</span>

<span class="sd">        A name attribute will be randomly generated unless </span>
<span class="sd">        a `name` argument is given. There is no particular reason to name objects or create them</span>
<span class="sd">        explicitly, unless we want to control the query text exactly.</span>

<span class="sd">        Note that in the following example `pIS.start` is synonymous with `part`.</span>

<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; q = Query(db)</span>
<span class="sd">        &gt;&gt;&gt; part = Node(q, &#39;Part&#39;, name=&#39;Part1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; pIS = q.setStartRelationship(relationType=&#39;PartInScore&#39;, name=&#39;PIS1&#39;, start=part)</span>
<span class="sd">        &gt;&gt;&gt; measure = Node(q, &#39;Measure&#39;, name=&#39;Measure1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; mIP = q.addRelationship(relationType=&#39;MeasureInPart&#39;, name=&#39;MIP1&#39;, start=measure, end=pIS.start)</span>
<span class="sd">        &gt;&gt;&gt; print mIP</span>
<span class="sd">        (Measure1)-[MIP1:MeasureInPart]-&gt;(Part1)</span>
<span class="sd">        </span>
<span class="sd">        Setting the `optional` argument to True will cause the query pattern to match even</span>
<span class="sd">        if this relationship doesn&#39;t exist in a particular instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">relation</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">relation</span> <span class="o">=</span> <span class="n">Relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relationType</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="n">optional</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="p">(</span><span class="n">relation</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">relation</span><span class="o">.</span><span class="n">end</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">nodeType</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span> <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relation</span>
    </div>
    <span class="k">def</span> <span class="nf">addNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodeType</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nodeId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodeType</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">nodeId</span><span class="p">)</span>
    
<div class="viewcode-block" id="Query.addComparisonFilter"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Query.addComparisonFilter">[docs]</a>    <span class="k">def</span> <span class="nf">addComparisonFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a condition to the query that must be true in order for the query to match, and returns</span>
<span class="sd">        the corresponding :class:`Filter` object.</span>
<span class="sd">        </span>
<span class="sd">        The `pre` and `post` arguments should be either:</span>
<span class="sd">        </span>
<span class="sd">        * an attribute of a :class:`Node` or :class:`Relationship` (which will return a</span>
<span class="sd">          :class:`Property` object), or</span>
<span class="sd">        * some text or a number.</span>
<span class="sd">         </span>
<span class="sd">        The list of available properties can be obtained from the :meth:`Database.printStructure` </span>
<span class="sd">        method. Of course, if any of those Nodes or Relationships aren&#39;t objects in the query,</span>
<span class="sd">        the query will fail to match. </span>
<span class="sd">        </span>
<span class="sd">        The `operator` argument is a text string of the comparison we want to test</span>
<span class="sd">        between the two properties. The available comparison operators are</span>
<span class="sd">        `=, &lt;&gt;, &lt;, &gt;, &lt;=,` and `&gt;=`.</span>

<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; q = Query(db)</span>
<span class="sd">        &gt;&gt;&gt; n1 = Node(q, &#39;Note&#39;, name=&#39;Note1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print q.addComparisonFilter(n1.midi, &#39;&lt;&#39;, 43)</span>
<span class="sd">        Note1.midi &lt; 43</span>
<span class="sd">                </span>
<span class="sd">        There is no need for us to build all these relationships between notes, measures, parts,</span>
<span class="sd">        and scores, unless we want to return information about them or add filters to them.</span>
<span class="sd">        In this case the Note object by itself would be enough </span>
<span class="sd">        (using just the :meth:`setStartNode` method).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">Filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">post</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filt</span>
        </div>
<div class="viewcode-block" id="Query.addCypherFilter"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Query.addCypherFilter">[docs]</a>    <span class="k">def</span> <span class="nf">addCypherFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        **For advanced use. This method will be probably be deprecated in future versions.**</span>
<span class="sd">        </span>
<span class="sd">        Adds a condition written in </span>
<span class="sd">        `Cypher &lt;http://docs.neo4j.org/chunked/milestone/query-where.html&gt;`_ to the query.</span>
<span class="sd">        This method is provided for complex queries that require filters more complicated</span>
<span class="sd">        than basic comparisons. </span>
<span class="sd">        </span>
<span class="sd">        In referring to a entity being used in the query, the Cypher query text must use </span>
<span class="sd">        the name of the entity, which can be obtained from its `name` attribute.</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; q = Query(db)</span>
<span class="sd">        &gt;&gt;&gt; nSWN = q.setStartRelationship(relationType=&#39;NoteSimultaneousWithNote&#39;)</span>
<span class="sd">        &gt;&gt;&gt; q.addCypherFilter(&#39;abs(%s.midi- %s.midi) %% 12 = 7&#39; % (nSWN.start.name, nSWN.end.name))</span>
<span class="sd">        &gt;&gt;&gt; results, meta = q.results(limit=100)</span>
<span class="sd">        &gt;&gt;&gt; print len(results)</span>
<span class="sd">        70</span>
<span class="sd">        </span>
<span class="sd">        But we can create this filter more directly using the `simpleHarmonicInterval` property</span>
<span class="sd">        of `NoteSimultaneousWithNote` relationships:</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; f = q.addComparisonFilter(nSWN.simpleHarmonicInterval, &#39;=&#39;, 7)        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Query.addReturns"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Query.addReturns">[docs]</a>    <span class="k">def</span> <span class="nf">addReturns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">props</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a list of properties to be returned from the query. Each of these properties</span>
<span class="sd">        should be a :class:`Property` object returned by accessing an attribute of a</span>
<span class="sd">        :class:`Node` or :class:`Relationship` object. The list of available attributes can be</span>
<span class="sd">        obtained using the :meth:`Database.printStructure` method.</span>
<span class="sd">        </span>
<span class="sd">        If this method is set, the requested properties will be returned as text, numbers, </span>
<span class="sd">        and so forth. If it is not set, the query will return a list of </span>
<span class="sd">        :class:`py2neo.neo4j.Node` and :class:`py2neo.neo4j.Relationship` objects.</span>
<span class="sd">        </span>
<span class="sd">        This method can be called multiple times, and the items from each call will be appended</span>
<span class="sd">        to the list of returns.</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; db = Database()</span>
<span class="sd">        &gt;&gt;&gt; q = Query(db)</span>
<span class="sd">        &gt;&gt;&gt; nSWN = q.setStartRelationship(relationType=&#39;NoteSimultaneousWithNote&#39;)</span>
<span class="sd">        &gt;&gt;&gt; f = q.addComparisonFilter(nSWN.simpleHarmonicInterval, &#39;=&#39;, 7)</span>
<span class="sd">        &gt;&gt;&gt; q.addReturns(nSWN.start.midi, nSWN.end.midi)</span>
<span class="sd">        &gt;&gt;&gt; r, meta = q.results()</span>
<span class="sd">        &gt;&gt;&gt; sorted([sorted(x) for x in r])[0]</span>
<span class="sd">        [42, 61]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="c">#    def printResults(self):</span>
<span class="c">#        &#39;&#39;&#39;Prints out the results of a query in tab-delimited format with the column names in</span>
<span class="c">#        the first row. If the :meth:`execute` method has not been called, it is called</span>
<span class="c">#        automatically.</span>
<span class="c">#        &#39;&#39;&#39;</span>
<span class="c">#        if self.results == None:</span>
<span class="c">#            self.execute()</span>
<span class="c">#        sys.stderr.write(&#39;%d results:\n&#39; % len(self.results))</span>
<span class="c">#        print &#39;\t&#39;.join(self.metadata)</span>
<span class="c">#        for row in self.results:</span>
<span class="c">#            print &#39;\t&#39;.join([str(x) for x in row])</span>
</div>
<div class="viewcode-block" id="Query.music21Score"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Query.music21Score">[docs]</a>    <span class="k">def</span> <span class="nf">music21Score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resultList</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a music21 :class:`~music21.stream.Score` object, given a single</span>
<span class="sd">        query result (which is by default a list of :class:`py2neo.neo4j.Node`</span>
<span class="sd">        and :class:`py2neo.neo4j.Relationship` objects). This method will only</span>
<span class="sd">        work if the :meth:`addReturns` method has not been called.</span>
<span class="sd">        </span>
<span class="sd">        The Score will contain its Metadata, all the measures and parts containing the query results,</span>
<span class="sd">        and all the objects contained in those measures, but no more than that.  </span>

<span class="sd">        If the metadata from the query is included, the score will include</span>
<span class="sd">        information useful for matching query nodes with score objects. Objects</span>
<span class="sd">        in the score that correspond to nodes in the query will have a</span>
<span class="sd">        &quot;queryName&quot; attribute that contains the query column name.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeLookup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">resultList</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addHierarchicalNodes</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getResultProperties</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">itemTuple</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemTuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">py2neo</span><span class="o">.</span><span class="n">neo4j</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">itemTuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="n">nodes</span><span class="p">[</span><span class="n">itemTuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">itemTuple</span>
<span class="c">#                    print itemTuple</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itemTuple</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">Score</span><span class="p">()</span>
        <span class="n">scoreNodeId</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">nodes</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Score&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addHierarchicalMusic21Data</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">scoreNodeId</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">relations</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score</span>
</div>
<div class="viewcode-block" id="Query.setObjectCallback"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Query.setObjectCallback">[docs]</a>    <span class="k">def</span> <span class="nf">setObjectCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;**For advanced use.**</span>

<span class="sd">        All node types have default handling when being exported to music21 objects.</span>
<span class="sd">        When default handling isn&#39;t enough, one or more callbacks can be added</span>
<span class="sd">        to preprocess the object, or prevent it from being added to the Score.</span>
<span class="sd">        The callback is responsible for adding the object to the score.</span>
<span class="sd">        The `entity` argument is the class name the callback should be added to </span>
<span class="sd">        (as a string), and the `callback` argument is a function object to be called.</span>
<span class="sd">        Only one callback is allowed per class name, so each call to this method</span>
<span class="sd">        will replace the previous value set by the method for that entity.</span>
<span class="sd">        Built-in callbacks are set in the internal :meth:`_defaultCallbacks` method.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constructCallbacks</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>
    </div>
    <span class="k">def</span> <span class="nf">_defaultCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c"># TieInNote</span>
        <span class="k">def</span> <span class="nf">setTie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tieDict</span><span class="p">,</span> <span class="n">tie</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">note</span><span class="o">.</span><span class="n">tie</span> <span class="o">=</span> <span class="n">tie</span>
            <span class="k">return</span> <span class="n">tie</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;TieInNote&#39;</span><span class="p">,</span> <span class="n">setTie</span><span class="p">)</span>
        
        <span class="c"># BeamInNote</span>
        <span class="k">def</span> <span class="nf">addBeam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beamDict</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">number</span> <span class="o">=</span> <span class="n">_convertFromString</span><span class="p">(</span><span class="n">beamDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;number&#39;</span><span class="p">,</span> <span class="s">&#39;None&#39;</span><span class="p">))</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">_convertFromString</span><span class="p">(</span><span class="n">beamDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;direction&#39;</span><span class="p">,</span> <span class="s">&#39;None&#39;</span><span class="p">))</span>
            <span class="n">beamType</span> <span class="o">=</span> <span class="n">beamDict</span><span class="p">[</span><span class="s">&#39;m21_type&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">number</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">note</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">setByNumber</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">beamType</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">note</span><span class="o">.</span><span class="n">beams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beamType</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;BeamInNote&#39;</span><span class="p">,</span> <span class="n">addBeam</span><span class="p">)</span>
        
        <span class="c"># ContributorInMetadata</span>
        <span class="k">def</span> <span class="nf">addContributorText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contributorDict</span><span class="p">,</span> <span class="n">contributor</span><span class="p">,</span> <span class="n">metadataObj</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">metadataObj</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">contributorDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_names&#39;</span><span class="p">))</span>
            <span class="n">contributor</span><span class="o">.</span><span class="n">_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">metadataObj</span><span class="o">.</span><span class="n">addContributor</span><span class="p">(</span><span class="n">contributor</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">contributor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;ContributorInMetadata&#39;</span><span class="p">,</span> <span class="n">addContributorText</span><span class="p">)</span>
        
        <span class="c"># PartInScore</span>
        <span class="k">def</span> <span class="nf">removePartNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partDict</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">partDict</span><span class="p">[</span><span class="s">&#39;number&#39;</span><span class="p">]</span>
            <span class="n">score</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">part</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;PartInScore&#39;</span><span class="p">,</span> <span class="n">removePartNumber</span><span class="p">)</span>
        
        <span class="c"># MeasureInPart</span>
        <span class="k">def</span> <span class="nf">addSignaturesAndClefs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measureDict</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">firstMeasure</span> <span class="o">=</span> <span class="p">(</span><span class="n">_convertFromString</span><span class="p">(</span><span class="n">measureDict</span><span class="p">[</span><span class="s">&#39;offset&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoreOffset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">measureDict</span><span class="p">[</span><span class="s">&#39;clefIsNew&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span> <span class="ow">or</span> <span class="n">firstMeasure</span><span class="p">:</span>
                <span class="n">classLookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listMusic21Classes</span><span class="p">()</span>
                <span class="n">clef</span> <span class="o">=</span> <span class="n">classLookup</span><span class="p">[</span><span class="n">measureDict</span><span class="p">[</span><span class="s">&#39;clef&#39;</span><span class="p">]]()</span>
                <span class="n">measure</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">clef</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">measureDict</span><span class="p">[</span><span class="s">&#39;keyIsNew&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span> <span class="ow">or</span> <span class="n">firstMeasure</span><span class="p">:</span>
                <span class="n">sharps</span> <span class="o">=</span> <span class="n">_convertFromString</span><span class="p">(</span><span class="n">measureDict</span><span class="p">[</span><span class="s">&#39;keySignatureSharps&#39;</span><span class="p">])</span>
                <span class="n">keySig</span> <span class="o">=</span> <span class="n">music21</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">KeySignature</span><span class="p">(</span><span class="n">sharps</span><span class="p">)</span>
                <span class="n">keySig</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">_convertFromString</span><span class="p">(</span><span class="n">measureDict</span><span class="p">[</span><span class="s">&#39;keySignatureMode&#39;</span><span class="p">])</span>
                <span class="n">measure</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">keySig</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">measureDict</span><span class="p">[</span><span class="s">&#39;timeSignatureIsNew&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span> <span class="ow">or</span> <span class="n">firstMeasure</span><span class="p">:</span>
                <span class="n">timeSig</span> <span class="o">=</span> <span class="n">meter</span><span class="o">.</span><span class="n">TimeSignature</span><span class="p">(</span><span class="n">measureDict</span><span class="p">[</span><span class="s">&#39;timeSignature&#39;</span><span class="p">])</span>
                <span class="n">measure</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">timeSig</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;clef&#39;</span><span class="p">,</span> <span class="s">&#39;keySignatureSharps&#39;</span><span class="p">,</span> <span class="s">&#39;keySignatureMode&#39;</span><span class="p">,</span> <span class="s">&#39;timeSignature&#39;</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">measureDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">part</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">measure</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">measure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;MeasureInPart&#39;</span><span class="p">,</span> <span class="n">addSignaturesAndClefs</span><span class="p">)</span>
        
        <span class="c"># MidmeasureClefInMeasure</span>
        <span class="k">def</span> <span class="nf">addMidmeasureClef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clefDict</span><span class="p">,</span> <span class="n">clef</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">classLookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listMusic21Classes</span><span class="p">()</span>
            <span class="n">clef</span> <span class="o">=</span> <span class="n">classLookup</span><span class="p">[</span><span class="n">clefDict</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]()</span>
            <span class="n">measure</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">clef</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">clef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;MidmeasureClefInMeasure&#39;</span><span class="p">,</span> <span class="n">addMidmeasureClef</span><span class="p">)</span>
        
        <span class="c"># NoteInMeasure</span>
        <span class="k">def</span> <span class="nf">setPitchAndDuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">noteDict</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="c"># .nameWithOctave is not read/write in music21 1.0.</span>
            <span class="kn">import</span> <span class="nn">re</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;[0-9]*&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">noteDict</span><span class="p">[</span><span class="s">&#39;pitch&#39;</span><span class="p">])</span>
            <span class="n">note</span><span class="o">.</span><span class="n">midi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">noteDict</span><span class="p">[</span><span class="s">&#39;midi&#39;</span><span class="p">])</span>
            <span class="n">note</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">note</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">isGrace</span> <span class="o">=</span> <span class="n">_convertFromString</span><span class="p">(</span><span class="n">noteDict</span><span class="p">[</span><span class="s">&#39;isGrace&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">note</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">isGrace</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;stealTimePrevious&#39;</span><span class="p">,</span> <span class="s">&#39;stealTimeFollowing&#39;</span><span class="p">,</span> <span class="s">&#39;slash&#39;</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">noteDict</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">noteDict</span><span class="p">[</span><span class="s">&#39;pitch&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">noteDict</span><span class="p">[</span><span class="s">&#39;midi&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">noteDict</span><span class="p">[</span><span class="s">&#39;isGrace&#39;</span><span class="p">]</span>
            <span class="n">measure</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">note</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;NoteInMeasure&#39;</span><span class="p">,</span> <span class="n">setPitchAndDuration</span><span class="p">)</span>
            
        <span class="c"># ArticulationInNote, ExpressionInNote</span>
        <span class="k">def</span> <span class="nf">replaceWithSpecificClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classDict</span><span class="p">,</span> <span class="n">classObj</span><span class="p">,</span> <span class="n">noteObj</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">classLookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listMusic21Classes</span><span class="p">()</span>
            <span class="n">childType</span> <span class="o">=</span> <span class="n">classDict</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">classLookup</span><span class="p">[</span><span class="n">childType</span><span class="p">]()</span>
            <span class="n">classAttribute</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__module__</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span> 
            <span class="nb">getattr</span><span class="p">(</span><span class="n">noteObj</span><span class="p">,</span> <span class="n">classAttribute</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;ArticulationInNote&#39;</span><span class="p">,</span> <span class="n">replaceWithSpecificClass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;ExpressionInNote&#39;</span><span class="p">,</span> <span class="n">replaceWithSpecificClass</span><span class="p">)</span>
        
        <span class="c"># PartInStaffGroup</span>
        <span class="k">def</span> <span class="nf">addPartsToStaffGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partDict</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">staffGroup</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">childId</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">id</span>            
            <span class="n">part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeLookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">childId</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">part</span><span class="p">:</span>
                <span class="n">staffGroup</span><span class="o">.</span><span class="n">addSpannedElements</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;PartInStaffGroup&#39;</span><span class="p">,</span> <span class="n">addPartsToStaffGroup</span><span class="p">)</span>
        
        <span class="c"># spannerTo</span>
        <span class="k">def</span> <span class="nf">replaceWithSpecificSpanner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">noteDict</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">otherNote</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">classLookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listMusic21Classes</span><span class="p">()</span>
            <span class="n">spanDict</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">spanType</span> <span class="o">=</span> <span class="n">spanDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
            <span class="n">span</span> <span class="o">=</span> <span class="n">classLookup</span><span class="p">[</span><span class="n">spanType</span><span class="p">]()</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeLookup</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeLookup</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="n">span</span><span class="o">.</span><span class="n">addComponents</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addProperties</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">spanDict</span><span class="p">)</span>
            <span class="n">measure</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">getContextByClass</span><span class="p">(</span><span class="s">&#39;Measure&#39;</span><span class="p">)</span>
            <span class="n">measure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">span</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;spannerTo&#39;</span><span class="p">,</span> <span class="n">replaceWithSpecificSpanner</span><span class="p">)</span>
        
        <span class="c"># Default</span>
        <span class="k">def</span> <span class="nf">defaultChild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">childDict</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="s">&#39;offset&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s">&#39;insert&#39;</span><span class="p">):</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s">&#39;append&#39;</span><span class="p">):</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> has no append function for </span><span class="si">%s</span><span class="s"> objects! Please set a callback function.&#39;</span> 
                                 <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">child</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setObjectCallback</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">defaultChild</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_listMusic21Classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;classLookup&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">classLookup</span>
        <span class="kn">import</span> <span class="nn">pkgutil</span>
        <span class="kn">import</span> <span class="nn">inspect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classLookup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">importer</span><span class="p">,</span> <span class="n">modname</span><span class="p">,</span> <span class="n">ispkg</span> <span class="ow">in</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">iter_modules</span><span class="p">(</span><span class="n">music21</span><span class="o">.</span><span class="n">__path__</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ispkg</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;music21.&#39;</span> <span class="o">+</span> <span class="n">modname</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classLookup</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">classLookup</span>

    <span class="k">def</span> <span class="nf">_inspectMusic21ExpressionsArticulations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">inspect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m21_classes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># inspect music21 modules:</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">articulations</span><span class="p">):</span>
            <span class="n">mName</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">__name__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m21_classes</span><span class="p">[</span><span class="n">mName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cName</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m21_classes</span><span class="p">[</span><span class="n">mName</span><span class="p">][</span><span class="n">cName</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>

    <span class="k">def</span> <span class="nf">_assemblePattern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c">#        for node in self.nodes:</span>
<span class="c">#            self.addComparisonFilter(node.type, &#39;=&#39;, node.nodeType)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span>
        <span class="n">startStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="k">if</span> <span class="n">startStr</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;setStartNode() or setStartRelationship() must be called first.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">matchStr</span> <span class="o">=</span> <span class="n">whereStr</span> <span class="o">=</span> <span class="n">returnStr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">:</span>
            <span class="n">matchStr</span> <span class="o">=</span> <span class="s">&#39;match</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;,</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="p">:</span>
            <span class="n">whereStr</span> <span class="o">=</span> <span class="s">&#39;where</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">:</span>
            <span class="n">returnStr</span> <span class="o">=</span> <span class="s">&#39;return &#39;</span> <span class="o">+</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">returnStr</span> <span class="o">=</span> <span class="s">&#39;return *</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">limitStr</span> <span class="o">=</span> <span class="s">&#39;limit {maxResults}</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">skipStr</span> <span class="o">=</span> <span class="s">&#39;skip {minRow}</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">startStr</span> <span class="o">+</span> <span class="n">matchStr</span> <span class="o">+</span> <span class="n">whereStr</span> <span class="o">+</span> <span class="n">returnStr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="n">skipStr</span> <span class="o">+</span> <span class="n">limitStr</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span>

    <span class="k">def</span> <span class="nf">_addHierarchicalNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Fill in a minimal score hierarchy sufficient to contain the notes in the result.</span>
<span class="sd">        Then fill in all the other notes in the minimal score.</span>
<span class="sd">        Then add one more layer of nodes within the objects in the score </span>
<span class="sd">        (articulations, dynamics, expressions, etc.).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">relations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filterNodesAndRelationships</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">relations</span><span class="p">)</span>
        
        <span class="c"># For each note in the result, fill in the structural nodes above it.</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s">&#39;Note&#39;</span><span class="p">)</span>
        <span class="n">inMeasure</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="s">&#39;NoteInMeasure&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="n">inPart</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="s">&#39;MeasureInPart&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">inMeasure</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
        <span class="n">inScore</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="s">&#39;PartInScore&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">inPart</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="s">&#39;InstrumentInPart&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">inPart</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="s">&#39;MetadataInScore&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">inScore</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="s">&#39;StaffGroupInScore&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">inScore</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">_getPy2neoMetadata</span><span class="p">(</span><span class="n">node</span><span class="p">)[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;Note&#39;</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">node</span><span class="o">.</span><span class="n">queryName</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">n</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span>
            <span class="n">q</span><span class="o">.</span><span class="n">setStartNode</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">subresults</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">results</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filterNodesAndRelationships</span><span class="p">(</span><span class="n">subresults</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">relations</span><span class="p">)</span>
        
        <span class="c"># Fill in the other notes in the measures.</span>
        <span class="n">measures</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">_getPy2neoMetadata</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Measure&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scoreOffset</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">_getPy2neoMetadata</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;offset&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addChildren</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&#39;NoteInMeasure&#39;</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">relations</span><span class="p">)</span>

        <span class="c"># Add one more layer of objects below the existing ones.</span>
        <span class="n">rTypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">listRelationshipTypes</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">nType</span> <span class="o">=</span> <span class="n">_getPy2neoMetadata</span><span class="p">(</span><span class="n">node</span><span class="p">)[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
            <span class="n">inNodeRTypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rTypes</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;end&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">nType</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">inNodeRTypes</span><span class="p">:</span>
                <span class="n">rType</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rType</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;In&#39;</span> <span class="o">+</span> <span class="n">nType</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rType</span> <span class="o">==</span> <span class="s">&#39;spannerTo&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">rType</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;NoteInMeasure&#39;</span><span class="p">,</span> <span class="s">&#39;MomentInScore&#39;</span><span class="p">,</span> <span class="s">&#39;PartInScore&#39;</span><span class="p">,</span> <span class="s">&#39;MeasureInPart&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addChildren</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">rType</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">relations</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">relations</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_filterNodesAndRelationships</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">relations</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Nodes and Relations must be hashed separately to avoid ID number clashes.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">py2neo</span><span class="o">.</span><span class="n">neo4j</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="n">nodes</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">relations</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
    
    <span class="k">def</span> <span class="nf">_addChildren</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rType</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">relations</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add all the children of this node that are connected by the specified Relationship type.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">nodeId</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">setStartNode</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="n">relationType</span><span class="o">=</span><span class="n">rType</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="n">subresults</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">subresults</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filterNodesAndRelationships</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">relations</span><span class="p">)</span>
                    
    <span class="k">def</span> <span class="nf">_addHierarchicalMusic21Data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">parentId</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">relates</span><span class="p">):</span>
        <span class="c"># Some bits of the music21-to-MusicXML conversion process are sensitive to order.</span>
        <span class="n">relatesToNode</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">relates</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">end_node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">parentId</span><span class="p">],</span>
                               <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">relatesToNode</span><span class="p">:</span>
            <span class="n">rType</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
            <span class="n">parentType</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rType</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;In&#39;</span> <span class="o">+</span> <span class="n">parentType</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rType</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;spannerTo&#39;</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">childId</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start_node</span><span class="o">.</span><span class="n">id</span>
            <span class="n">childDict</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">childId</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addMusic21Child</span><span class="p">(</span><span class="n">childDict</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">child</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">queryName</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">childId</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;queryName&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">queryName</span><span class="p">:</span>
                <span class="n">child</span><span class="o">.</span><span class="n">editorial</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="s">&quot;red&quot;</span>
                <span class="n">child</span><span class="o">.</span><span class="n">queryName</span> <span class="o">=</span> <span class="n">queryName</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeLookup</span><span class="p">[</span><span class="n">childId</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addHierarchicalMusic21Data</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">childId</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">relates</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_addMusic21Child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">childDict</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="n">classLookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listMusic21Classes</span><span class="p">()</span>
        <span class="n">childType</span> <span class="o">=</span> <span class="n">childDict</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">childType</span> <span class="ow">in</span> <span class="n">classLookup</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">classLookup</span><span class="p">[</span><span class="n">childType</span><span class="p">]()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">rType</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructCallbacks</span><span class="p">:</span>
            <span class="n">rType</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span>
        <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructCallbacks</span><span class="p">[</span><span class="n">rType</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">childDict</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">child</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addMusic21Properties</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">childDict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">child</span>

    <span class="k">def</span> <span class="nf">_addMusic21Properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objDict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">objDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;type&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;m21_&#39;</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">_convertFromString</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

<span class="c">#-------------------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="Entity"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Entity">[docs]</a><span class="k">class</span> <span class="nc">Entity</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;The generic class of objects that are used to construct queries.</span>
<span class="sd">    All entities require a :class:`Query` object as their first argument</span>
<span class="sd">    to establish the namespace which they belong to. </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">_DOC_ATTR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;The text string that names the entity in the query and in the results.&#39;</span><span class="p">,</span>             
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span>
    
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_addName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">entityType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span>
            <span class="k">if</span> <span class="n">entityType</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">entityType</span> <span class="o">=</span> <span class="s">&#39;Generic&#39;</span>
            <span class="n">testName</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entityType</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9999</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">testName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_usedNames</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">testName</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_usedNames</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;The name &quot;</span><span class="si">%s</span><span class="s">&quot; is already being used.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_usedNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Entity</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;An object that represents a database node in a query.</span>
<span class="sd">    </span>
<span class="sd">    If the Node is created without a nodeType, the node will match any type.</span>
<span class="sd">    The list of available node types is can be obtained</span>
<span class="sd">    from the :meth:`Database.printStructure` method.</span>
<span class="sd">    </span>
<span class="sd">    A name attribute will be randomly generated unless a `name` argument</span>
<span class="sd">    is given. There is no particular reason to name objects unless we want to control </span>
<span class="sd">    the query text exactly.</span>

<span class="sd">    Each node in a Neo4j database has a numeric ID, and passing that ID to the `nodeId` argument</span>
<span class="sd">    will save it in the Node&#39;s `id` attribute.</span>
<span class="sd">    If a Node with an ID number is passed to the :meth:`Query.setStartNode` method,</span>
<span class="sd">    that ID will be used to target the search. Otherwise the `id` attribute is ignored.</span>
<span class="sd">    </span>
<span class="sd">    Any properties of a node type can be accessed as an attribute of the Node. Accessing a</span>
<span class="sd">    Node&#39;s attribute will return a :class:`Property` object for that node property, which can be</span>
<span class="sd">    used with the :meth:`Query.addComparisonFilter` and :meth:`Query.addReturns` methods.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">_DOC_ATTR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;nodeType&#39;</span><span class="p">:</span> <span class="s">&#39;The type of database node this object represents.&#39;</span><span class="p">,</span>
    <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="s">&#39;The numeric ID of this node in the database (default=None).&#39;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">nodeType</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nodeId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Entity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nodeType</span><span class="p">:</span>
            <span class="n">nodeType</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeType</span> <span class="o">=</span> <span class="n">nodeType</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">nodeId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>    
        </div>
<div class="viewcode-block" id="Relationship"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Relationship">[docs]</a><span class="k">class</span> <span class="nc">Relationship</span><span class="p">(</span><span class="n">Entity</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;An object that represents a database relationship in a query.</span>
<span class="sd">    </span>
<span class="sd">    If the Relationship is created without a relationType, the relationship will match any type.</span>
<span class="sd">    The list of available relationship types is available</span>
<span class="sd">    from the :meth:`Database.printStructure` method.</span>
<span class="sd">    </span>
<span class="sd">    The `start` and `end` arguments take :class:`Node` objects, and allow the relationship </span>
<span class="sd">    to be connected to other nodes in the query. If either is omitted, a new node object</span>
<span class="sd">    is created implicitly to fill it.</span>

<span class="sd">    A name attribute will be randomly generated unless a `name` argument</span>
<span class="sd">    is given. There is no particular reason to name objects unless we want to control </span>
<span class="sd">    the query text exactly.</span>

<span class="sd">    Any properties of a relationship type can be accessed as an attribute of the</span>
<span class="sd">    Relationship. Accessing a Relationship&#39;s attribute will return a</span>
<span class="sd">    :class:`Property` object for that relationship property, which can be used</span>
<span class="sd">    with the :meth:`Query.addComparisonFilter` and :meth:`Query.addReturns`</span>
<span class="sd">    methods.</span>
<span class="sd">    </span>
<span class="sd">    Setting the `optional` argument to True will cause the query pattern to match even</span>
<span class="sd">    if this relationship doesn&#39;t exist in a particular instance.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">_DOC_ATTR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;relationType&#39;</span><span class="p">:</span> <span class="s">&#39;The type of database relationship this object represents.&#39;</span><span class="p">,</span>
    <span class="s">&#39;start&#39;</span><span class="p">:</span> <span class="s">&#39;The start :class:`Node` of this relationship.&#39;</span><span class="p">,</span>
    <span class="s">&#39;end&#39;</span><span class="p">:</span> <span class="s">&#39;The end :class:`Node` of this relationship&#39;</span><span class="p">,</span>
    <span class="s">&#39;optional&#39;</span><span class="p">:</span> <span class="s">&quot;Whether the query pattern will match even if this relationship doesn&#39;t exist in a particular instance&quot;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">relationType</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">Entity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">relationType</span><span class="p">:</span>
            <span class="n">relationType</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationType</span> <span class="o">=</span> <span class="n">relationType</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">Node</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span> <span class="ow">or</span> <span class="n">Node</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">optional</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="s">&#39;?&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">)-[</span><span class="si">%s%s</span><span class="s">:</span><span class="si">%s</span><span class="s">]-&gt;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optional</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Property"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Property">[docs]</a><span class="k">class</span> <span class="nc">Property</span><span class="p">(</span><span class="n">Entity</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;An object representing a property of a node or relationship in the database.</span>
<span class="sd">    </span>
<span class="sd">    Accessing an attribute of a :class:`Node` or :class:`Relationship` will return a</span>
<span class="sd">    :class:`Property` object, which can be used</span>
<span class="sd">    with the :meth:`Query.addComparisonFilter` and :meth:`Query.addReturns`</span>
<span class="sd">    methods.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">Entity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span>
        </div>
<div class="viewcode-block" id="Filter"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Filter">[docs]</a><span class="k">class</span> <span class="nc">Filter</span><span class="p">(</span><span class="n">Entity</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;An object representing a filter phrase in a query, which is a condition </span>
<span class="sd">    that must be true for the query to match.</span>
<span class="sd">    </span>
<span class="sd">    The `pre` and `post` arguments are the values that are being tested, and should each be either:</span>
<span class="sd">    </span>
<span class="sd">    * an attribute of a :class:`Node` or :class:`Relationship` (which will return a</span>
<span class="sd">      :class:`Property` object), or</span>
<span class="sd">    * some text or a number.</span>
<span class="sd">     </span>
<span class="sd">    The list of available node and relationship properties can be obtained </span>
<span class="sd">    from the :meth:`Database.printStructure` method.</span>
<span class="sd">    </span>
<span class="sd">    The `operator` argument is a text string of the comparison we want to test</span>
<span class="sd">    between the two properties. The available comparison operators are</span>
<span class="sd">    `=, &lt;&gt;, &lt;, &gt;, &lt;=,` and `&gt;=`.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>
        <span class="n">Entity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">pre</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="n">operator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">post</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">operands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)):</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">operand</span>
                <span class="n">operands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">operands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">operand</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span>
</div>
<div class="viewcode-block" id="Moment"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Moment">[docs]</a><span class="k">class</span> <span class="nc">Moment</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Music21Object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This object is similar in purpose to a</span>
<span class="sd">    :class:`~music21.voiceLeading.VerticalSlice` in that it contains every</span>
<span class="sd">    :class:`~music21.note.Note` that occurs at a given offset in a</span>
<span class="sd">    :class:`~music21.stream.Score`. (Notes are stored as references</span>
<span class="sd">    to the original objects in :class:`~weakref.WeakSet` objects.) A Moment acts like a</span>
<span class="sd">    :class:`~music21.spanner.Spanner` placed at the end of a Score.</span>
<span class="sd">    </span>
<span class="sd">    A Moment can serve the same function as a VerticalSlice or a call </span>
<span class="sd">    to :meth:`~music21.stream.Stream.getElementsByOffset` on a flattened Score,</span>
<span class="sd">    providing easy access to all the Notes active at a particular offset.</span>
<span class="sd">    It is also a place to store information about that moment in the score, such as</span>
<span class="sd">    chord quality or pitch-class set.</span>
<span class="sd">    </span>
<span class="sd">    When a Score with Moments is added to a :class:`Database` object, it will</span>
<span class="sd">    add vertical relationships between Notes (`NoteSimultaneousWithNote`). It</span>
<span class="sd">    will also add Moment nodes to the database, along with their corresponding</span>
<span class="sd">    Note relationships (`NoteStartsAtMoment` and `NoteSustainedAtMoment`).</span>
<span class="sd">    </span>
<span class="sd">    Typically Moments are added to a score via the :meth:`musicNet.addMomentsToScore` </span>
<span class="sd">    class method. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">_DOC_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;getComponents&#39;</span><span class="p">,</span> <span class="s">&#39;addComponents&#39;</span><span class="p">]</span>
    
    <span class="n">_DOC_ATTR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;sameOffset&#39;</span><span class="p">:</span> <span class="s">&#39;A :class:`weakref.WeakSet` referring to all the Notes starting at the Moment.&#39;</span><span class="p">,</span>
    <span class="s">&#39;simultaneous&#39;</span><span class="p">:</span> <span class="s">&#39;A :class:`weakref.WeakSet` referring to any Notes that started before the Moment but hold over into it.&#39;</span>
    <span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sameOffset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">arguments</span><span class="p">):</span>
        <span class="n">base</span><span class="o">.</span><span class="n">Music21Object</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sameOffset</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakSet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simultaneous</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakSet</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addComponents</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">sameOffset</span><span class="p">,</span> <span class="o">*</span><span class="n">arguments</span><span class="p">)</span>
        
<div class="viewcode-block" id="Moment.getComponents"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Moment.getComponents">[docs]</a>    <span class="k">def</span> <span class="nf">getComponents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the contents of the object as a :class:`weakref.WeakSet`. This is simply the</span>
<span class="sd">        union of two of the object&#39;s attributes: `sameOffset` and `simultaneous`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sameOffset</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">simultaneous</span>
    </div>
<div class="viewcode-block" id="Moment.addComponents"><a class="viewcode-back" href="../../musicNet.html#music21.musicNet.Moment.addComponents">[docs]</a>    <span class="k">def</span> <span class="nf">addComponents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">sameOffset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">arguments</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a :class:`~music21.note.Note` object (or a list of Notes) to the</span>
<span class="sd">        object. If a Note has the same offset as this object, a reference to it</span>
<span class="sd">        is added to `sameOffset`. Otherwise a reference is added to `simultaneous`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">common</span><span class="o">.</span><span class="n">isListLike</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
            <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="n">components</span><span class="p">]</span>
        <span class="n">components</span> <span class="o">+=</span> <span class="n">arguments</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">note</span><span class="o">.</span><span class="n">Note</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;cannot add a non-Note object to a Moment&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sameOffset</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sameOffset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sameOffset</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sameOffset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getContextByClass</span><span class="p">(</span><span class="s">&#39;Measure&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">offset</span>
                <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sameOffset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">simultaneous</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>        
</div></div>
<span class="k">class</span> <span class="nc">Test</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">runTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
<span class="k">class</span> <span class="nc">TestExternal</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">runTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="n">_DOC_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="n">Query</span><span class="p">,</span> <span class="n">Database</span><span class="p">,</span> <span class="n">Entity</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Relationship</span><span class="p">,</span> <span class="n">Property</span><span class="p">,</span> <span class="n">Filter</span><span class="p">,</span> <span class="n">Moment</span><span class="p">]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">_prepDoctests</span><span class="p">()</span>
    <span class="n">music21</span><span class="o">.</span><span class="n">mainTest</span><span class="p">(</span><span class="n">Test</span><span class="p">)</span>

<span class="c"># This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. </span>
<span class="c"># If a copy of the MPL was not distributed with this file, You can obtain one at </span>
<span class="c"># http://mozilla.org/MPL/2.0/.</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">musicNet 0.2 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Bret Aarden.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>